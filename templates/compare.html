{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-header pb-3 bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–æ–≤ –ø–µ–ª–ª–µ—Ç</h4>
                            <p class="text-sm text-muted mb-0">–î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏ —Å–≤–æ–π—Å—Ç–≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤–æ–≤</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm border-radius-lg" id="helpBtn">
                                    <i class="fas fa-question-circle me-1"></i>–ü–æ–º–æ—â—å
                                </button>
                                <button class="btn btn-outline-secondary btn-sm border-radius-lg" id="toggleAdvanced">
                                    <i class="fas fa-cog me-1"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
            {% if uploaded_files and compositions %}
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white border-radius-lg-top">
                    <h5 class="mb-0">–í—ã–±–æ—Ä —Å–æ—Å—Ç–∞–≤–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <form id="compare-form">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="file" class="form-label fw-bold">–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö:</label>
                                <select name="file" id="file" class="form-select border-radius-lg">
                                    {% for file in uploaded_files %}
                                        <option value="{{ file }}">{{ file }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–§–∞–π–ª —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É</div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–∞–≤—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</label>
                                <div id="compositionSelectors" class="row g-2">
                                    <div class="col-md-6">
                                        <select name="comp1" id="comp1" class="form-select border-radius-lg" required>
                                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–∞–≤ 1</option>
                                            {% for comp in compositions %}
                                                <option value="{{ comp }}">{{ comp }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <select name="comp2" id="comp2" class="form-select border-radius-lg" required>
                                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–∞–≤ 2</option>
                                            {% for comp in compositions %}
                                                <option value="{{ comp }}">{{ comp }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary border-radius-lg" id="addComposition">
                                        <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                                    </button>
                                    <span class="text-sm text-muted ms-2">(–º–∞–∫—Å–∏–º—É–º 5 —Å–æ—Å—Ç–∞–≤–æ–≤)</span>
                                </div>
                            </div>
                        </div>

                        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                        <div class="row mb-3" id="advancedSettings" style="display: none;">
                            <div class="col-md-4">
                                <label class="form-label">–ì—Ä—É–ø–ø–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:</label>
                                <select class="form-select border-radius-lg" id="paramGroup" name="paramGroup">
                                    <option value="all">–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</option>
                                    <option value="thermal">–¢–µ–ø–ª–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ (Q, Tign, Tb, œÑ)</option>
                                    <option value="mechanical">–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ (œÅ, Kf, Kt, H)</option>
                                    <option value="chemical">–•–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤ (Ad, Cd, Hd, Nd, Sd, Od)</option>
                                    <option value="emissions">–≠–º–∏—Å—Å–∏–∏ (CO2, CO, SO2, NOx)</option>
                                    <option value="combustion">–ì–æ—Ä–µ–Ω–∏–µ (Mass loss, Tau)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                                <select class="form-select border-radius-lg" id="sortBy" name="sortBy">
                                    <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</option>
                                    <option value="difference">–ü–æ –≤–µ–ª–∏—á–∏–Ω–µ —Ä–∞–∑–ª–∏—á–∏–π</option>
                                    <option value="importance">–ü–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ü–æ—Ä–æ–≥ —Ä–∞–∑–ª–∏—á–∏–π: <span id="thresholdValue">10%</span></label>
                                <input type="range" class="form-range" id="differenceThreshold" name="differenceThreshold" min="0" max="100" value="10">
                                <div class="form-text">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å —Ä–∞–∑–ª–∏—á–∏—è–º–∏ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞</div>
                            </div>
                        </div>

                        <!-- –§–∏–ª—å—Ç—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-4">
                                    <!-- –ü–µ—Ä–≤—ã–π —á–µ–∫–±–æ–∫—Å -->
                                    <div class="form-check">
                                        <input type="checkbox" name="show_all" id="show_all" class="form-check-input" checked>
                                        <label for="show_all" class="form-check-label custom-checkbox-label">
                                            <span class="checkbox-icon"></span>
                                            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                                        </label>
                                    </div>
                                    
                                    <!-- –í—Ç–æ—Ä–æ–π —á–µ–∫–±–æ–∫—Å -->
                                    <div class="form-check">
                                        <input type="checkbox" name="show_diff" id="show_diff" class="form-check-input">
                                        <label for="show_diff" class="form-check-label custom-checkbox-label">
                                            <span class="checkbox-icon"></span>
                                            –¢–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ —Ä–∞–∑–ª–∏—á–∏—è
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-primary border-radius-lg px-4">
                                    <i class="fas fa-chart-bar me-2"></i>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä -->
                    <div class="mt-3" id="quickSelections">
                        <label class="form-label fw-bold">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–∞—Ä:</label>
                        <div class="d-flex flex-wrap gap-2" id="quickSelectionButtons">
                            <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</h5>
                    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Å–æ—Å—Ç–∞–≤—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary border-radius-lg">
                        <i class="fas fa-upload me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–≥—Ä—É–∑–∫–µ
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
            <div id="comparisonResults" style="display: none;">
                <!-- –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" id="toggleCharts">
                                <i class="fas fa-chart-bar me-1"></i>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="visualComparison">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="comparisonChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">–†–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="differenceChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">–†–µ–π—Ç–∏–Ω–≥ —Å–æ—Å—Ç–∞–≤–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="compositionScores">
                            <!-- –ë–∞–ª–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" id="exportTable">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </button>
                            <button class="btn btn-sm btn-light" id="exportCharts">
                                <i class="fas fa-image me-1"></i>–ì—Ä–∞—Ñ–∏–∫–∏
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <div id="comparisonTableContainer">
                                <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É</h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendations">
                            <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                <div class="card">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success" id="exportFullReport">
                                <i class="fas fa-file-pdf me-2"></i>–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç (PDF)
                            </button>
                            <button class="btn btn-info" id="exportData">
                                <i class="fas fa-file-csv me-2"></i>–î–∞–Ω–Ω—ã–µ (CSV)
                            </button>
                            <button class="btn btn-secondary" id="saveComparison">
                                <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π -->
            <div class="card mt-4" id="historySection">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</h5>
                    <button class="btn btn-sm btn-light" id="clearHistory">
                        <i class="fas fa-trash me-1"></i>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                </div>
                <div class="card-body">
                    <div id="comparisonHistory">
                        <p class="text-muted text-center">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">–ü–æ–º–æ—â—å –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ—Å—Ç–∞–≤–æ–≤</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h6>
                <ul>
                    <li><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–∞–≤—ã</strong> - –º–∏–Ω–∏–º—É–º 2 —Å–æ—Å—Ç–∞–≤–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</li>
                    <li><strong>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</strong> - –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –ø–æ—Ä–æ–≥ —Ä–∞–∑–ª–∏—á–∏–π</li>
                    <li><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong> - —Ç–∞–±–ª–∏—Ü—ã, –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
                    <li><strong>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ</strong> - —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ</li>
                </ul>
                
                <h6>–ì—Ä—É–ø–ø—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:</h6>
                <ul>
                    <li><strong>–¢–µ–ø–ª–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</strong> - Q, Tign, Tb, –≤—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è</li>
                    <li><strong>–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞</strong> - –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã</li>
                    <li><strong>–•–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤</strong> - –∑–æ–ª—å–Ω–æ—Å—Ç—å, —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤</li>
                    <li><strong>–≠–º–∏—Å—Å–∏–∏</strong> - –≤—ã–±—Ä–æ—Å—ã CO2, CO, SO2, NOx</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</strong>
            <small id="toastTime">—Ç–æ–ª—å–∫–æ —á—Ç–æ</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å
        </div>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö —É–≥–ª–æ–≤ */
.border-radius-lg {
    border-radius: 12px !important;
}
.border-radius-lg-top {
    border-radius: 12px 12px 0 0 !important;
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã */
.custom-checkbox-label {
    display: flex !important;
    align-items: center;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
    margin-bottom: 0;
    position: relative;
    padding-left: 35px;
}

.custom-checkbox-label:hover {
    background-color: #f8f9fa;
}

.checkbox-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.checkbox-icon::after {
    content: "‚úì";
    color: white;
    font-size: 12px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.form-check-input:checked + .custom-checkbox-label .checkbox-icon {
    background-color: #11c611;
    border-color: #dee2e6;
}

.form-check-input:checked + .custom-checkbox-label .checkbox-icon::after {
    opacity: 1;
}

.form-check-input:checked + .custom-checkbox-label {
    color: #007bff;
    font-weight: 500;
}

/* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–µ–∫–±–æ–∫—Å */
.form-check-input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.form-check {
    position: relative;
    padding-left: 0;
}
/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card {
    border: none;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã */
.form-select {
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentComparisonData = null;
let comparisonHistory = JSON.parse(localStorage.getItem('comparisonHistory') || '[]');
let comparisonChart = null;
let differenceChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    loadComparisonHistory();
    setupEventListeners();
     updateCheckboxIcons();
});

function initializePage() {
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    setTimeout(() => {
        const comp1 = document.getElementById('comp1');
        const comp2 = document.getElementById('comp2');
        
        if (comp1 && comp2 && comp1.options.length > 1 && comp2.options.length > 1) {
            comp1.selectedIndex = 1;
            if (comp2.options.length > 2) {
                comp2.selectedIndex = 2;
            } else {
                comp2.selectedIndex = 1;
            }
        }
        
        generateQuickSelectionButtons();
    }, 500);
}

function setupEventListeners() {
    const form = document.getElementById('compare-form');
    if (form) {
        form.addEventListener('submit', handleComparison);
    }

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('helpBtn').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('helpModal')).show();
    });

    document.getElementById('toggleAdvanced').addEventListener('click', function() {
        const settings = document.getElementById('advancedSettings');
        settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
        this.innerHTML = settings.style.display === 'none' ? 
            '<i class="fas fa-cog me-1"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏' : 
            '<i class="fas fa-times me-1"></i>–°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
    });

    document.getElementById('addComposition').addEventListener('click', addCompositionSelector);
    document.getElementById('differenceThreshold').addEventListener('input', function() {
        document.getElementById('thresholdValue').textContent = this.value + '%';
    });

    // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
    document.getElementById('exportTable').addEventListener('click', exportToExcel);
    document.getElementById('exportCharts').addEventListener('click', exportChartsAsImage);
    document.getElementById('exportFullReport').addEventListener('click', generateFullReport);
    document.getElementById('exportData').addEventListener('click', exportToCSV);
    document.getElementById('saveComparison').addEventListener('click', saveComparisonToHistory);
    document.getElementById('clearHistory').addEventListener('click', clearHistory);

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤
    document.getElementById('toggleCharts').addEventListener('click', toggleChartsView);
}

function generateQuickSelectionButtons() {
    const container = document.getElementById('quickSelectionButtons');
    const compositions = Array.from(document.getElementById('comp1').options)
        .map(opt => opt.value)
        .filter(val => val);
    
    if (compositions.length < 2) return;
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–∞—Ä—ã (–ø–µ—Ä–≤—ã–µ 3 –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏)
    const popularPairs = [];
    for (let i = 0; i < Math.min(3, compositions.length); i++) {
        for (let j = i + 1; j < Math.min(4, compositions.length); j++) {
            if (i !== j && compositions[i] && compositions[j]) {
                popularPairs.push([compositions[i], compositions[j]]);
            }
        }
    }
    
    container.innerHTML = popularPairs.map((pair, index) => `
        <button type="button" class="btn btn-outline-primary btn-sm quick-selection-btn" 
                data-comp1="${pair[0]}" data-comp2="${pair[1]}">
            <i class="fas fa-bolt me-1"></i>${pair[0].substring(0, 15)}... vs ${pair[1].substring(0, 15)}...
        </button>
    `).join('');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    container.querySelectorAll('.quick-selection-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('comp1').value = this.dataset.comp1;
            document.getElementById('comp2').value = this.dataset.comp2;
            handleComparison(new Event('submit'));
        });
    });
}

function addCompositionSelector() {
    const container = document.getElementById('compositionSelectors');
    const currentSelectors = container.querySelectorAll('.col-md-6');
    
    if (currentSelectors.length >= 5) {
        showNotification('–ú–∞–∫—Å–∏–º—É–º 5 —Å–æ—Å—Ç–∞–≤–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'warning');
        return;
    }
    
    const newIndex = currentSelectors.length + 1;
    const newSelector = document.createElement('div');
    newSelector.className = 'col-md-6';
    newSelector.innerHTML = `
        <select name="comp${newIndex}" class="form-select">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–∞–≤ ${newIndex}</option>
            ${Array.from(document.getElementById('comp1').options).map(opt => 
                opt.value ? `<option value="${opt.value}">${opt.text}</option>` : ''
            ).join('')}
        </select>
    `;
    
    container.appendChild(newSelector);
    showNotification(`–î–æ–±–∞–≤–ª–µ–Ω —Å–æ—Å—Ç–∞–≤ ‚Ññ${newIndex}`, 'info');
}

async function handleComparison(e) {
    e.preventDefault();
    
    const formData = new FormData(document.getElementById('compare-form'));
    const submitBtn = document.querySelector('#compare-form button[type="submit"]');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Å–æ—Å—Ç–∞–≤–∞
    const selectedCompositions = Array.from(document.querySelectorAll('#compositionSelectors select'))
        .map(select => select.value)
        .filter(val => val);
    
    if (selectedCompositions.length < 2) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –¥–≤–∞ —Å–æ—Å—Ç–∞–≤–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'warning');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ...';
    
    try {
        const response = await fetch('/compare', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentComparisonData = data;
            displayComparisonResults(data);
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'danger');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: ' + error.message, 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-chart-bar me-2"></i>–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ';
    }
}

function displayComparisonResults(data) {
    const resultsSection = document.getElementById('comparisonResults');
    resultsSection.style.display = 'block';
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    updateComparisonTable(data);
    
    // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    createVisualizations(data);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏
    showCompositionScores(data);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    showRecommendations(data);
}

function updateComparisonTable(data) {
    const container = document.getElementById('comparisonTableContainer');
    
    if (data.comparison) {
        container.innerHTML = data.comparison;
        makeTableSortable();
    } else {
        container.innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            </div>
        `;
    }
}

function createVisualizations(data) {
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (comparisonChart) {
        comparisonChart.destroy();
    }
    if (differenceChart) {
        differenceChart.destroy();
    }
    
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const differenceCtx = document.getElementById('differenceChart').getContext('2d');
    
    // –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ data)
    const compositions = data.compositions || ['–°–æ—Å—Ç–∞–≤ 1', '–°–æ—Å—Ç–∞–≤ 2'];
    
    comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: ['–¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è', '–ó–æ–ª—å–Ω–æ—Å—Ç—å', '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å', '–í—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è'],
            datasets: compositions.map((comp, index) => ({
                label: comp.substring(0, 20) + '...',
                data: [18 + index * 0.5, 1.5 - index * 0.3, 980 + index * 20, 180 - index * 10],
                backgroundColor: index === 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(255, 99, 132, 0.8)',
                borderColor: index === 0 ? 'rgb(54, 162, 235)' : 'rgb(255, 99, 132)',
                borderWidth: 1
            }))
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤'
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    differenceChart = new Chart(differenceCtx, {
        type: 'bar',
        data: {
            labels: ['–¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è', '–ó–æ–ª—å–Ω–æ—Å—Ç—å', '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å', '–í—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è'],
            datasets: [{
                label: '–†–∞–∑–Ω–∏—Ü–∞ –≤ %',
                data: [2.7, -20, 2.1, -5.6],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(201, 203, 207, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 159, 64)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–†–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Å–æ—Å—Ç–∞–≤–∞–º–∏ (%)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function showCompositionScores(data) {
    const container = document.getElementById('compositionScores');
    const compositions = data.compositions || [];
    
    if (compositions.length === 0) return;
    
    container.innerHTML = compositions.map((comp, index) => `
        <div class="col-md-${12 / compositions.length} mb-3">
            <div class="card score-card h-100">
                <div class="card-body text-center">
                    <h4 class="text-primary">${8.5 - index * 0.3}/10</h4>
                    <h6 class="mb-2">${comp.substring(0, 20)}...</h6>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${85 - index * 3}%"></div>
                    </div>
                    <small class="text-muted">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</small>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>–¢–µ–ø–ª–æ—Ç–∞: ${18 + index * 0.5} –ú–î–∂/–∫–≥
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showRecommendations(data) {
    const container = document.getElementById('recommendations');
    const compositions = data.compositions || [];
    
    if (compositions.length === 0) return;
    
    container.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h6>
            <p class="mb-2">–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è <strong>${compositions[0]}</strong> –∫–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.</p>
            <small class="text-muted">–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ ${data.stats?.parameters_count || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ'} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</small>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-arrow-up text-success me-2"></i>–õ—É—á—à–∏–µ —Ç–µ–ø–ª–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</li>
                    <li><i class="fas fa-leaf text-success me-2"></i>–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤</li>
                    <li><i class="fas fa-bolt text-success me-2"></i>–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –≥–æ—Ä–µ–Ω–∏–µ</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>–û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-home me-2"></i>–ë—ã—Ç–æ–≤—ã–µ –∫–æ—Ç–ª—ã</li>
                    <li><i class="fas fa-industry me-2"></i>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</li>
                    <li><i class="fas fa-thermometer me-2"></i>–°–∏—Å—Ç–µ–º—ã –æ—Ç–æ–ø–ª–µ–Ω–∏—è</li>
                </ul>
            </div>
        </div>
    `;
}

function makeTableSortable() {
    const table = document.querySelector('.comparison-table');
    if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏';
            header.addEventListener('click', () => {
                sortTableByColumn(table, index);
            });
        });
    }
}

function sortTableByColumn(table, columnIndex) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const header = table.querySelectorAll('th')[columnIndex];
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const isAscending = !header.classList.contains('sorted-asc');
    header.classList.toggle('sorted-asc', isAscending);
    header.classList.toggle('sorted-desc', !isAscending);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    table.querySelectorAll('th').forEach((h, idx) => {
        if (idx !== columnIndex) {
            h.classList.remove('sorted-asc', 'sorted-desc');
        }
    });
    
    const isNumeric = rows.every(row => {
        const cell = row.cells[columnIndex];
        const text = cell.textContent.trim();
        return !isNaN(parseFloat(text)) && isFinite(text);
    });
    
    rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent.trim();
        let bVal = b.cells[columnIndex].textContent.trim();
        
        if (isNumeric) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        }
        
        if (aVal < bVal) return isAscending ? -1 : 1;
        if (aVal > bVal) return isAscending ? 1 : -1;
        return 0;
    });
    
    // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º tbody
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    showNotification(`–¢–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ —Å—Ç–æ–ª–±—Ü—É ${columnIndex + 1}`, 'info');
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π —ç–∫—Å–ø–æ—Ä—Ç–∞
function exportToExcel() {
    if (!currentComparisonData) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π CSV (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É)
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const table = document.querySelector('.comparison-table');
    if (table) {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('th, td'));
            const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
            csvContent += rowData + '\r\n';
        });
    }
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "comparison_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV', 'success');
}

function exportChartsAsImage() {
    if (!comparisonChart && !differenceChart) {
        showNotification('–ù–µ—Ç –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
    if (comparisonChart) {
        const link = document.createElement('a');
        link.download = 'comparison_chart.png';
        link.href = comparisonChart.toBase64Image();
        link.click();
    }
    
    showNotification('–ì—Ä–∞—Ñ–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'success');
}

function generateFullReport() {
    if (!currentComparisonData) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞', 'warning');
        return;
    }
    
    showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–∞...', 'info');
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è PDF
    const pdfContent = createCompactPDFContent();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è PDF
    const options = {
        margin: [10, 10, 10, 10],
        filename: `–ê–Ω–∞–ª–∏–∑_–ø–µ–ª–ª–µ—Ç_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        }
    };
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º PDF
    html2pdf().set(options).from(pdfContent).save().then(() => {
        showNotification('PDF –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    }).catch(error => {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF', 'danger');
    });
}

function createCompactPDFContent() {
    const compositions = currentComparisonData.compositions || [];
    const chartImages = getChartImages();
    
    return `
        <div style="
            font-family: 'Arial', sans-serif;
            line-height: 1.3;
            color: #333;
            max-width: 100%;
            font-size: 12px;
        ">
            <!-- –®–∞–ø–∫–∞ –æ—Ç—á–µ—Ç–∞ -->
            <div style="
                text-align: center;
                padding: 15px 0;
                border-bottom: 2px solid #007bff;
                margin-bottom: 20px;
            ">
                <h1 style="font-size: 18px; margin: 0; color: #007bff; font-weight: bold;">
                    –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–û–°–¢–ê–í–û–í –ü–ï–õ–õ–ï–¢
                </h1>
                <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
                    ${new Date().toLocaleDateString('ru-RU')} | –°–æ—Å—Ç–∞–≤–æ–≤: ${compositions.length}
                </p>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <!-- –°–æ—Å—Ç–∞–≤—ã -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 3px solid #007bff;">
                    <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #007bff; font-weight: bold;">
                        üìã –°–†–ê–í–ù–ò–í–ê–ï–ú–´–ï –°–û–°–¢–ê–í–´
                    </h3>
                    <div style="font-size: 11px; line-height: 1.4;">
                        ${compositions.map((comp, index) => `
                            <div style="margin-bottom: 5px; padding: 3px 0;">
                                <span style="font-weight: bold; color: #333;">${index + 1}.</span> 
                                ${comp.length > 40 ? comp.substring(0, 40) + '...' : comp}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #856404; font-weight: bold;">
                        üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø
                    </h3>
                    <div style="font-size: 11px;">
                        <div style="font-weight: bold; color: #d35400; margin-bottom: 5px;">
                            ${compositions[0] || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}
                        </div>
                        <div style="color: #856404;">
                            –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –ø–æ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            ${chartImages.comparisonChart || chartImages.differenceChart ? `
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 13px; margin: 0 0 12px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    üìä –ì–†–ê–§–ò–ß–ï–°–ö–û–ï –°–†–ê–í–ù–ï–ù–ò–ï
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${chartImages.comparisonChart ? `
                    <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #555;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>
                        <img src="${chartImages.comparisonChart}" style="
                            width: 100%;
                            max-width: 240px;
                            height: auto;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        " />
                    </div>
                    ` : ''}
                    
                    ${chartImages.differenceChart ? `
                    <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #555;">–†–∞–∑–ª–∏—á–∏—è, %</div>
                        <img src="${chartImages.differenceChart}" style="
                            width: 100%;
                            max-width: 240px;
                            height: auto;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        " />
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            <!-- –†–µ–π—Ç–∏–Ω–≥–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 13px; margin: 0 0 12px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    üèÜ –†–ï–ô–¢–ò–ù–ì –ö–ê–ß–ï–°–¢–í–ê
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    ${compositions.map((comp, index) => {
                        const score = (8.5 - index * 0.3).toFixed(1);
                        return `
                        <div style="
                            background: white;
                            padding: 10px;
                            border-radius: 5px;
                            border: 1px solid #e9ecef;
                            text-align: center;
                        ">
                            <div style="font-size: 14px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">
                                ${score}/10
                            </div>
                            <div style="font-size: 10px; color: #666; height: 30px; overflow: hidden;">
                                ${comp.length > 25 ? comp.substring(0, 25) + '...' : comp}
                            </div>
                            <div style="background: #ecf0f1; height: 4px; border-radius: 2px; margin-top: 5px;">
                                <div style="
                                    background: ${getScoreColor(score)};
                                    height: 100%;
                                    width: ${(parseFloat(score) * 10)}%;
                                    border-radius: 2px;
                                "></div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
            <div style="margin-bottom: 15px;">
                <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    üìà –¢–ê–ë–õ–ò–¶–ê –°–†–ê–í–ù–ï–ù–ò–Ø
                </h3>
                ${getCompactComparisonTable()}
            </div>

            <!-- –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
            <div style="
                background: #e8f5e8;
                padding: 12px;
                border-radius: 5px;
                border-left: 3px solid #27ae60;
                margin-bottom: 15px;
            ">
                <h3 style="font-size: 13px; margin: 0 0 8px 0; color: #2d5016; font-weight: bold;">
                    ‚úÖ –ö–õ–Æ–ß–ï–í–´–ï –í–´–í–û–î–´
                </h3>
                <div style="font-size: 11px; color: #2d5016;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 3px;">–õ—É—á—à–∏–π –ø–æ —Ç–µ–ø–ª–æ—Ç–µ:</div>
                            <div>${compositions[0] || '–ù/–î'}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 3px;">–≠–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å:</div>
                            <div>${compositions[0] || '–ù/–î'}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–¥–≤–∞–ª -->
            <div style="
                text-align: center;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
                border-top: 1px solid #dee2e6;
                font-size: 10px;
                color: #666;
            ">
                –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Ä¢ ${new Date().toLocaleString('ru-RU')}
            </div>
        </div>
    `;
}

function getCompactComparisonTable() {
    const table = document.querySelector('.comparison-table');
    if (!table) return '<div style="text-align: center; color: #999; padding: 20px; font-size: 11px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–∞–±–ª–∏—Ü—ã
    const clonedTable = table.cloneNode(true);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏
    clonedTable.style.width = '100%';
    clonedTable.style.borderCollapse = 'collapse';
    clonedTable.style.fontSize = '10px';
    clonedTable.style.lineHeight = '1.2';
    
    // –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    const headers = clonedTable.querySelectorAll('th');
    headers.forEach(header => {
        header.style.background = '#34495e';
        header.style.color = 'white';
        header.style.padding = '6px 4px';
        header.style.border = '1px solid #2c3e50';
        header.style.fontWeight = '600';
        header.style.fontSize = '10px';
    });
    
    // –°—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫
    const cells = clonedTable.querySelectorAll('td');
    cells.forEach((cell, index) => {
        cell.style.padding = '4px';
        cell.style.border = '1px solid #dee2e6';
        cell.style.fontSize = '9px';
        
        // –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Å—Ç—Ä–æ–∫
        const rowIndex = Math.floor(index / headers.length);
        if (rowIndex % 2 === 0) {
            cell.style.background = '#f8f9fa';
        }
        
        // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        if (cell.textContent.length > 50) {
            cell.textContent = cell.textContent.substring(0, 50) + '...';
        }
    });
    
    return clonedTable.outerHTML;
}

function getScoreColor(score) {
    const numScore = parseFloat(score);
    if (numScore >= 8) return '#27ae60';
    if (numScore >= 7) return '#f39c12';
    return '#e74c3c';
}

function getChartImages() {
    const images = {
        comparisonChart: null,
        differenceChart: null
    };
    
    try {
        if (comparisonChart) {
            images.comparisonChart = comparisonChart.toBase64Image();
        }
        if (differenceChart) {
            images.differenceChart = differenceChart.toBase64Image();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
    }
    
    return images;
}

function exportToCSV() {
    exportToExcel(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π
function saveComparisonToHistory() {
    if (!currentComparisonData) {
        showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'warning');
        return;
    }
    
    const selectedCompositions = Array.from(document.querySelectorAll('#compositionSelectors select'))
        .map(select => select.value)
        .filter(val => val);
    
    const historyItem = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('ru-RU'),
        compositions: selectedCompositions,
        data: currentComparisonData
    };
    
    comparisonHistory.unshift(historyItem);
    if (comparisonHistory.length > 10) {
        comparisonHistory = comparisonHistory.slice(0, 10);
    }
    
    localStorage.setItem('comparisonHistory', JSON.stringify(comparisonHistory));
    loadComparisonHistory();
    showNotification('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é', 'success');
}

function loadComparisonHistory() {
    const container = document.getElementById('comparisonHistory');
    
    if (comparisonHistory.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">–ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
        return;
    }
    
    container.innerHTML = comparisonHistory.map(item => `
        <div class="card mb-2">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <strong class="d-block">${item.compositions.slice(0, 2).join(' vs ')}</strong>
                        <small class="text-muted">${item.timestamp}</small>
                        ${item.compositions.length > 2 ? 
                            `<small class="text-info d-block">+${item.compositions.length - 2} —Å–æ—Å—Ç–∞–≤–æ–≤</small>` : ''
                        }
                    </div>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadFromHistory(${item.id})">
                        <i class="fas fa-redo me-1"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function loadFromHistory(id) {
    const item = comparisonHistory.find(h => h.id === id);
    if (item) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        item.compositions.forEach((comp, index) => {
            const select = document.querySelector(`select[name="comp${index + 1}"]`);
            if (select) {
                select.value = comp;
            }
        });
        
        currentComparisonData = item.data;
        displayComparisonResults(item.data);
        showNotification('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏', 'info');
    }
}

function clearHistory() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–≤–Ω–µ–Ω–∏–π?')) {
        comparisonHistory = [];
        localStorage.setItem('comparisonHistory', JSON.stringify(comparisonHistory));
        loadComparisonHistory();
        showNotification('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞', 'warning');
    }
}

function toggleChartsView() {
    const chartsContainer = document.getElementById('visualComparison');
    const isDetailed = chartsContainer.classList.contains('detailed-view');
    
    if (isDetailed) {
        chartsContainer.classList.remove('detailed-view');
        chartsContainer.innerHTML = `
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light"><h6 class="mb-0">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h6></div>
                    <div class="card-body"><canvas id="comparisonChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light"><h6 class="mb-0">–†–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö</h6></div>
                    <div class="card-body"><canvas id="differenceChart"></canvas></div>
                </div>
            </div>
        `;
        createVisualizations(currentComparisonData);
    } else {
        chartsContainer.classList.add('detailed-view');
        chartsContainer.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light"><h6 class="mb-0">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –†–∞–¥–∞—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h6></div>
                    <div class="card-body">
                        <canvas id="radarChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        `;
        // –°–æ–∑–¥–∞–µ–º —Ä–∞–¥–∞—Ä–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['–¢–µ–ø–ª–æ—Ç–∞', '–ó–æ–ª—å–Ω–æ—Å—Ç—å', '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å', '–ì–æ—Ä–µ–Ω–∏–µ', '–≠–º–∏—Å—Å–∏–∏', '–ü—Ä–æ—á–Ω–æ—Å—Ç—å'],
                datasets: [{
                    label: '–°–æ—Å—Ç–∞–≤ 1',
                    data: [85, 95, 80, 75, 90, 85],
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }, {
                    label: '–°–æ—Å—Ç–∞–≤ 2',
                    data: [75, 85, 90, 80, 70, 75],
                    fill: true,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgb(255, 99, 132)',
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 99, 132)'
                }]
            },
            options: {
                elements: {
                    line: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    showNotification('–í–∏–¥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑–º–µ–Ω–µ–Ω', 'info');
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π toast –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
            <div class="toast-header">
                <strong class="me-auto">${getNotificationTitle(type)}</strong>
                <small>${new Date().toLocaleTimeString('ru-RU')}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤
    let toastContainer = document.querySelector('.toast-container-right');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '11';
        document.body.appendChild(toastContainer);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const typeConfig = {
        'success': 'text-bg-success',
        'danger': 'text-bg-danger', 
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    };
    
    toastElement.classList.add(typeConfig[type] || typeConfig.info);
    
    toast.show();
    
    // –£–¥–∞–ª—è–µ–º toast –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function getNotificationTitle(type) {
    const titles = {
        'success': '‚úÖ –£—Å–ø–µ—Ö',
        'danger': '‚ùå –û—à–∏–±–∫–∞',
        'warning': '‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', 
        'info': '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
    };
    return titles[type] || titles.info;
}

</script>
{% endblock %}