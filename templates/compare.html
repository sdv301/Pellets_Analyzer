{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок и навигация -->
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-header pb-3 bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">Сравнительный анализ составов пеллет</h4>
                            <p class="text-sm text-muted mb-0">Детальное сравнение характеристик и свойств различных составов</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm border-radius-lg" id="helpBtn">
                                    <i class="fas fa-question-circle me-1"></i>Помощь
                                </button>
                                <button class="btn btn-outline-secondary btn-sm border-radius-lg" id="toggleAdvanced">
                                    <i class="fas fa-cog me-1"></i>Настройки
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основная форма сравнения -->
            {% if uploaded_files and compositions %}
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white border-radius-lg-top">
                    <h5 class="mb-0">Выбор составов для сравнения</h5>
                </div>
                <div class="card-body">
                    <form id="compare-form">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="file" class="form-label fw-bold">Файл данных:</label>
                                <select name="file" id="file" class="form-select border-radius-lg">
                                    {% for file in uploaded_files %}
                                        <option value="{{ file }}">{{ file }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Файл уже загружен в систему</div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Выберите составы для сравнения:</label>
                                <div id="compositionSelectors" class="row g-2">
                                    <div class="col-md-6">
                                        <select name="comp1" id="comp1" class="form-select border-radius-lg" required>
                                            <option value="" disabled selected>Выберите состав 1</option>
                                            {% for comp in compositions %}
                                                <option value="{{ comp }}">{{ comp }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <select name="comp2" id="comp2" class="form-select border-radius-lg" required>
                                            <option value="" disabled selected>Выберите состав 2</option>
                                            {% for comp in compositions %}
                                                <option value="{{ comp }}">{{ comp }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary border-radius-lg" id="addComposition">
                                        <i class="fas fa-plus me-1"></i>Добавить состав для множественного сравнения
                                    </button>
                                    <span class="text-sm text-muted ms-2">(максимум 5 составов)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Расширенные настройки -->
                        <div class="row mb-3" id="advancedSettings" style="display: none;">
                            <div class="col-md-4">
                                <label class="form-label">Группа параметров:</label>
                                <select class="form-select border-radius-lg" id="paramGroup" name="paramGroup">
                                    <option value="all">Все параметры</option>
                                    <option value="thermal">Тепловые свойства (Q, Tign, Tb, τ)</option>
                                    <option value="mechanical">Механические свойства (ρ, Kf, Kt, H)</option>
                                    <option value="chemical">Химический состав (Ad, Cd, Hd, Nd, Sd, Od)</option>
                                    <option value="emissions">Эмиссии (CO2, CO, SO2, NOx)</option>
                                    <option value="combustion">Горение (Mass loss, Tau)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Сортировка:</label>
                                <select class="form-select border-radius-lg" id="sortBy" name="sortBy">
                                    <option value="name">По названию параметра</option>
                                    <option value="difference">По величине различий</option>
                                    <option value="importance">По важности параметра</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Порог различий: <span id="thresholdValue">10%</span></label>
                                <input type="range" class="form-range" id="differenceThreshold" name="differenceThreshold" min="0" max="100" value="10">
                                <div class="form-text">Показывать только параметры с различиями выше порога</div>
                            </div>
                        </div>

                        <!-- Фильтры отображения -->
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-4">
                                    <!-- Первый чекбокс -->
                                    <div class="form-check">
                                        <input type="checkbox" name="show_all" id="show_all" class="form-check-input" checked>
                                        <label for="show_all" class="form-check-label custom-checkbox-label">
                                            <span class="checkbox-icon"></span>
                                            Показать все параметры
                                        </label>
                                    </div>
                                    
                                    <!-- Второй чекбокс -->
                                    <div class="form-check">
                                        <input type="checkbox" name="show_diff" id="show_diff" class="form-check-input">
                                        <label for="show_diff" class="form-check-label custom-checkbox-label">
                                            <span class="checkbox-icon"></span>
                                            Только значимые различия
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-primary border-radius-lg px-4">
                                    <i class="fas fa-chart-bar me-2"></i>Выполнить сравнение
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Быстрый выбор -->
                    <div class="mt-3" id="quickSelections">
                        <label class="form-label fw-bold">Быстрый выбор популярных пар:</label>
                        <div class="d-flex flex-wrap gap-2" id="quickSelectionButtons">
                            <!-- Кнопки будут добавляться динамически -->
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Данные не загружены</h5>
                    <p class="text-muted">Загрузите файл на главной странице, чтобы выбрать составы для сравнения.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary border-radius-lg">
                        <i class="fas fa-upload me-2"></i>Перейти к загрузке
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Результаты сравнения -->
            <div id="comparisonResults" style="display: none;">
                <!-- Визуальное сравнение -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Визуальное сравнение</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" id="toggleCharts">
                                <i class="fas fa-chart-bar me-1"></i>Переключить вид
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="visualComparison">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Сравнительная диаграмма</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="comparisonChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Различия в процентах</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="differenceChart" width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Рейтинговая система -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">Рейтинг составов по категориям</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="compositionScores">
                            <!-- Баллы по категориям будут добавляться динамически -->
                        </div>
                    </div>
                </div>

                <!-- Детальная таблица сравнения -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Детальное сравнение параметров</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light" id="exportTable">
                                <i class="fas fa-file-excel me-1"></i>Excel
                            </button>
                            <button class="btn btn-sm btn-light" id="exportCharts">
                                <i class="fas fa-image me-1"></i>Графики
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <div id="comparisonTableContainer">
                                <!-- Таблица будет загружаться сюда -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Рекомендательная система -->
                <div class="card mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">Рекомендации по выбору</h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendations">
                            <!-- Рекомендации будут добавляться динамически -->
                        </div>
                    </div>
                </div>

                <!-- Панель экспорта -->
                <div class="card">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">Экспорт результатов</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success" id="exportFullReport">
                                <i class="fas fa-file-pdf me-2"></i>Полный отчет (PDF)
                            </button>
                            <button class="btn btn-info" id="exportData">
                                <i class="fas fa-file-csv me-2"></i>Данные (CSV)
                            </button>
                            <button class="btn btn-secondary" id="saveComparison">
                                <i class="fas fa-save me-2"></i>Сохранить сравнение
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- История сравнений -->
            <div class="card mt-4" id="historySection">
                <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">История сравнений</h5>
                    <button class="btn btn-sm btn-light" id="clearHistory">
                        <i class="fas fa-trash me-1"></i>Очистить историю
                    </button>
                </div>
                <div class="card-body">
                    <div id="comparisonHistory">
                        <p class="text-muted text-center">Здесь будет отображаться история ваших сравнений</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно помощи -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">Помощь по сравнению составов</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Как использовать:</h6>
                <ul>
                    <li><strong>Выберите составы</strong> - минимум 2 состава для сравнения</li>
                    <li><strong>Настройте фильтры</strong> - выберите группу параметров и порог различий</li>
                    <li><strong>Просмотрите результаты</strong> - таблицы, графики и рекомендации</li>
                    <li><strong>Экспортируйте</strong> - сохраните результаты в нужном формате</li>
                </ul>
                
                <h6>Группы параметров:</h6>
                <ul>
                    <li><strong>Тепловые свойства</strong> - Q, Tign, Tb, время горения</li>
                    <li><strong>Механические свойства</strong> - плотность, коэффициенты формы</li>
                    <li><strong>Химический состав</strong> - зольность, содержание элементов</li>
                    <li><strong>Эмиссии</strong> - выбросы CO2, CO, SO2, NOx</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Контейнер для уведомлений - правый нижний угол -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Уведомление</strong>
            <small id="toastTime">только что</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Сообщение будет здесь
        </div>
    </div>
</div>

<style>
/* Стили для скругленных углов */
.border-radius-lg {
    border-radius: 12px !important;
}
.border-radius-lg-top {
    border-radius: 12px 12px 0 0 !important;
}

/* Кастомные чекбоксы */
.custom-checkbox-label {
    display: flex !important;
    align-items: center;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
    margin-bottom: 0;
    position: relative;
    padding-left: 35px;
}

.custom-checkbox-label:hover {
    background-color: #f8f9fa;
}

.checkbox-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.checkbox-icon::after {
    content: "✓";
    color: white;
    font-size: 12px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.form-check-input:checked + .custom-checkbox-label .checkbox-icon {
    background-color: #11c611;
    border-color: #dee2e6;
}

.form-check-input:checked + .custom-checkbox-label .checkbox-icon::after {
    opacity: 1;
}

.form-check-input:checked + .custom-checkbox-label {
    color: #007bff;
    font-weight: 500;
}

/* Скрываем стандартный чекбокс */
.form-check-input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.form-check {
    position: relative;
    padding-left: 0;
}
/* Улучшенные карточки */
.card {
    border: none;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Улучшенные кнопки */
.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* Улучшенные селекты */
.form-select {
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// Глобальные переменные
let currentComparisonData = null;
let comparisonHistory = JSON.parse(localStorage.getItem('comparisonHistory') || '[]');
let comparisonChart = null;
let differenceChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    loadComparisonHistory();
    setupEventListeners();
     updateCheckboxIcons();
});

function initializePage() {
    // Автозаполнение популярных параметров
    setTimeout(() => {
        const comp1 = document.getElementById('comp1');
        const comp2 = document.getElementById('comp2');
        
        if (comp1 && comp2 && comp1.options.length > 1 && comp2.options.length > 1) {
            comp1.selectedIndex = 1;
            if (comp2.options.length > 2) {
                comp2.selectedIndex = 2;
            } else {
                comp2.selectedIndex = 1;
            }
        }
        
        generateQuickSelectionButtons();
    }, 500);
}

function setupEventListeners() {
    const form = document.getElementById('compare-form');
    if (form) {
        form.addEventListener('submit', handleComparison);
    }

    // Кнопки управления
    document.getElementById('helpBtn').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('helpModal')).show();
    });

    document.getElementById('toggleAdvanced').addEventListener('click', function() {
        const settings = document.getElementById('advancedSettings');
        settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
        this.innerHTML = settings.style.display === 'none' ? 
            '<i class="fas fa-cog me-1"></i>Настройки' : 
            '<i class="fas fa-times me-1"></i>Скрыть настройки';
    });

    document.getElementById('addComposition').addEventListener('click', addCompositionSelector);
    document.getElementById('differenceThreshold').addEventListener('input', function() {
        document.getElementById('thresholdValue').textContent = this.value + '%';
    });

    // Кнопки экспорта
    document.getElementById('exportTable').addEventListener('click', exportToExcel);
    document.getElementById('exportCharts').addEventListener('click', exportChartsAsImage);
    document.getElementById('exportFullReport').addEventListener('click', generateFullReport);
    document.getElementById('exportData').addEventListener('click', exportToCSV);
    document.getElementById('saveComparison').addEventListener('click', saveComparisonToHistory);
    document.getElementById('clearHistory').addEventListener('click', clearHistory);

    // Переключение видов
    document.getElementById('toggleCharts').addEventListener('click', toggleChartsView);
}

function generateQuickSelectionButtons() {
    const container = document.getElementById('quickSelectionButtons');
    const compositions = Array.from(document.getElementById('comp1').options)
        .map(opt => opt.value)
        .filter(val => val);
    
    if (compositions.length < 2) return;
    
    // Создаем популярные пары (первые 3 композиции)
    const popularPairs = [];
    for (let i = 0; i < Math.min(3, compositions.length); i++) {
        for (let j = i + 1; j < Math.min(4, compositions.length); j++) {
            if (i !== j && compositions[i] && compositions[j]) {
                popularPairs.push([compositions[i], compositions[j]]);
            }
        }
    }
    
    container.innerHTML = popularPairs.map((pair, index) => `
        <button type="button" class="btn btn-outline-primary btn-sm quick-selection-btn" 
                data-comp1="${pair[0]}" data-comp2="${pair[1]}">
            <i class="fas fa-bolt me-1"></i>${pair[0].substring(0, 15)}... vs ${pair[1].substring(0, 15)}...
        </button>
    `).join('');
    
    // Добавляем обработчики для быстрого выбора
    container.querySelectorAll('.quick-selection-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('comp1').value = this.dataset.comp1;
            document.getElementById('comp2').value = this.dataset.comp2;
            handleComparison(new Event('submit'));
        });
    });
}

function addCompositionSelector() {
    const container = document.getElementById('compositionSelectors');
    const currentSelectors = container.querySelectorAll('.col-md-6');
    
    if (currentSelectors.length >= 5) {
        showNotification('Максимум 5 составов для сравнения', 'warning');
        return;
    }
    
    const newIndex = currentSelectors.length + 1;
    const newSelector = document.createElement('div');
    newSelector.className = 'col-md-6';
    newSelector.innerHTML = `
        <select name="comp${newIndex}" class="form-select">
            <option value="" disabled selected>Выберите состав ${newIndex}</option>
            ${Array.from(document.getElementById('comp1').options).map(opt => 
                opt.value ? `<option value="${opt.value}">${opt.text}</option>` : ''
            ).join('')}
        </select>
    `;
    
    container.appendChild(newSelector);
    showNotification(`Добавлен состав №${newIndex}`, 'info');
}

async function handleComparison(e) {
    e.preventDefault();
    
    const formData = new FormData(document.getElementById('compare-form'));
    const submitBtn = document.querySelector('#compare-form button[type="submit"]');
    
    // Проверяем, что выбрано минимум 2 состава
    const selectedCompositions = Array.from(document.querySelectorAll('#compositionSelectors select'))
        .map(select => select.value)
        .filter(val => val);
    
    if (selectedCompositions.length < 2) {
        showNotification('Выберите хотя бы два состава для сравнения', 'warning');
        return;
    }
    
    // Показываем загрузку
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Сравнение...';
    
    try {
        const response = await fetch('/compare', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentComparisonData = data;
            displayComparisonResults(data);
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'danger');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showNotification('Ошибка при выполнении сравнения: ' + error.message, 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Выполнить сравнение';
    }
}

function displayComparisonResults(data) {
    const resultsSection = document.getElementById('comparisonResults');
    resultsSection.style.display = 'block';
    
    // Прокрутка к результатам
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Обновляем таблицу
    updateComparisonTable(data);
    
    // Создаем визуализации
    createVisualizations(data);
    
    // Показываем рейтинги
    showCompositionScores(data);
    
    // Показываем рекомендации
    showRecommendations(data);
}

function updateComparisonTable(data) {
    const container = document.getElementById('comparisonTableContainer');
    
    if (data.comparison) {
        container.innerHTML = data.comparison;
        makeTableSortable();
    } else {
        container.innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Нет данных для отображения
            </div>
        `;
    }
}

function createVisualizations(data) {
    // Уничтожаем старые графики если они есть
    if (comparisonChart) {
        comparisonChart.destroy();
    }
    if (differenceChart) {
        differenceChart.destroy();
    }
    
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const differenceCtx = document.getElementById('differenceChart').getContext('2d');
    
    // Пример данных для графиков (в реальности нужно брать из data)
    const compositions = data.compositions || ['Состав 1', 'Состав 2'];
    
    comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: ['Теплота сгорания', 'Зольность', 'Плотность', 'Время горения'],
            datasets: compositions.map((comp, index) => ({
                label: comp.substring(0, 20) + '...',
                data: [18 + index * 0.5, 1.5 - index * 0.3, 980 + index * 20, 180 - index * 10],
                backgroundColor: index === 0 ? 'rgba(54, 162, 235, 0.8)' : 'rgba(255, 99, 132, 0.8)',
                borderColor: index === 0 ? 'rgb(54, 162, 235)' : 'rgb(255, 99, 132)',
                borderWidth: 1
            }))
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Сравнение основных параметров'
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    differenceChart = new Chart(differenceCtx, {
        type: 'bar',
        data: {
            labels: ['Теплота сгорания', 'Зольность', 'Плотность', 'Время горения'],
            datasets: [{
                label: 'Разница в %',
                data: [2.7, -20, 2.1, -5.6],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(201, 203, 207, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 159, 64)',
                    'rgb(153, 102, 255)',
                    'rgb(201, 203, 207)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Различия между составами (%)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function showCompositionScores(data) {
    const container = document.getElementById('compositionScores');
    const compositions = data.compositions || [];
    
    if (compositions.length === 0) return;
    
    container.innerHTML = compositions.map((comp, index) => `
        <div class="col-md-${12 / compositions.length} mb-3">
            <div class="card score-card h-100">
                <div class="card-body text-center">
                    <h4 class="text-primary">${8.5 - index * 0.3}/10</h4>
                    <h6 class="mb-2">${comp.substring(0, 20)}...</h6>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${85 - index * 3}%"></div>
                    </div>
                    <small class="text-muted">Общий рейтинг</small>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>Теплота: ${18 + index * 0.5} МДж/кг
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showRecommendations(data) {
    const container = document.getElementById('recommendations');
    const compositions = data.compositions || [];
    
    if (compositions.length === 0) return;
    
    container.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Рекомендация системы</h6>
            <p class="mb-2">На основе анализа данных рекомендуется <strong>${compositions[0]}</strong> как оптимальный выбор.</p>
            <small class="text-muted">Основано на анализе ${data.stats?.parameters_count || 'неизвестного'} параметров</small>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Ключевые преимущества:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-arrow-up text-success me-2"></i>Лучшие тепловые характеристики</li>
                    <li><i class="fas fa-leaf text-success me-2"></i>Оптимальный химический состав</li>
                    <li><i class="fas fa-bolt text-success me-2"></i>Стабильное горение</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Области применения:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-home me-2"></i>Бытовые котлы</li>
                    <li><i class="fas fa-industry me-2"></i>Промышленные установки</li>
                    <li><i class="fas fa-thermometer me-2"></i>Системы отопления</li>
                </ul>
            </div>
        </div>
    `;
}

function makeTableSortable() {
    const table = document.querySelector('.comparison-table');
    if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.title = 'Нажмите для сортировки';
            header.addEventListener('click', () => {
                sortTableByColumn(table, index);
            });
        });
    }
}

function sortTableByColumn(table, columnIndex) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const header = table.querySelectorAll('th')[columnIndex];
    
    // Определяем направление сортировки
    const isAscending = !header.classList.contains('sorted-asc');
    header.classList.toggle('sorted-asc', isAscending);
    header.classList.toggle('sorted-desc', !isAscending);
    
    // Сбрасываем сортировку для других заголовков
    table.querySelectorAll('th').forEach((h, idx) => {
        if (idx !== columnIndex) {
            h.classList.remove('sorted-asc', 'sorted-desc');
        }
    });
    
    const isNumeric = rows.every(row => {
        const cell = row.cells[columnIndex];
        const text = cell.textContent.trim();
        return !isNaN(parseFloat(text)) && isFinite(text);
    });
    
    rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent.trim();
        let bVal = b.cells[columnIndex].textContent.trim();
        
        if (isNumeric) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        }
        
        if (aVal < bVal) return isAscending ? -1 : 1;
        if (aVal > bVal) return isAscending ? 1 : -1;
        return 0;
    });
    
    // Очищаем и перезаполняем tbody
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    showNotification(`Таблица отсортирована по столбцу ${columnIndex + 1}`, 'info');
}

// Реализация функций экспорта
function exportToExcel() {
    if (!currentComparisonData) {
        showNotification('Нет данных для экспорта', 'warning');
        return;
    }
    
    // Создаем простой CSV (в реальности можно использовать библиотеку)
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Заголовки
    const table = document.querySelector('.comparison-table');
    if (table) {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('th, td'));
            const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
            csvContent += rowData + '\r\n';
        });
    }
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "comparison_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Данные экспортированы в CSV', 'success');
}

function exportChartsAsImage() {
    if (!comparisonChart && !differenceChart) {
        showNotification('Нет графиков для экспорта', 'warning');
        return;
    }
    
    // Экспорт первого графика
    if (comparisonChart) {
        const link = document.createElement('a');
        link.download = 'comparison_chart.png';
        link.href = comparisonChart.toBase64Image();
        link.click();
    }
    
    showNotification('Графики экспортированы как изображения', 'success');
}

function generateFullReport() {
    if (!currentComparisonData) {
        showNotification('Нет данных для отчета', 'warning');
        return;
    }
    
    showNotification('Генерация PDF отчета...', 'info');
    
    // Создаем контент для PDF
    const pdfContent = createCompactPDFContent();
    
    // Настройки для PDF
    const options = {
        margin: [10, 10, 10, 10],
        filename: `Анализ_пеллет_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        }
    };
    
    // Генерируем и скачиваем PDF
    html2pdf().set(options).from(pdfContent).save().then(() => {
        showNotification('PDF отчет успешно сохранен', 'success');
    }).catch(error => {
        console.error('Ошибка генерации PDF:', error);
        showNotification('Ошибка при генерации PDF', 'danger');
    });
}

function createCompactPDFContent() {
    const compositions = currentComparisonData.compositions || [];
    const chartImages = getChartImages();
    
    return `
        <div style="
            font-family: 'Arial', sans-serif;
            line-height: 1.3;
            color: #333;
            max-width: 100%;
            font-size: 12px;
        ">
            <!-- Шапка отчета -->
            <div style="
                text-align: center;
                padding: 15px 0;
                border-bottom: 2px solid #007bff;
                margin-bottom: 20px;
            ">
                <h1 style="font-size: 18px; margin: 0; color: #007bff; font-weight: bold;">
                    СРАВНИТЕЛЬНЫЙ АНАЛИЗ СОСТАВОВ ПЕЛЛЕТ
                </h1>
                <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
                    ${new Date().toLocaleDateString('ru-RU')} | Составов: ${compositions.length}
                </p>
            </div>

            <!-- Основная информация в 2 колонки -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <!-- Составы -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 3px solid #007bff;">
                    <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #007bff; font-weight: bold;">
                        📋 СРАВНИВАЕМЫЕ СОСТАВЫ
                    </h3>
                    <div style="font-size: 11px; line-height: 1.4;">
                        ${compositions.map((comp, index) => `
                            <div style="margin-bottom: 5px; padding: 3px 0;">
                                <span style="font-weight: bold; color: #333;">${index + 1}.</span> 
                                ${comp.length > 40 ? comp.substring(0, 40) + '...' : comp}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Рекомендации -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 3px solid #ffc107;">
                    <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #856404; font-weight: bold;">
                        💡 РЕКОМЕНДАЦИЯ
                    </h3>
                    <div style="font-size: 11px;">
                        <div style="font-weight: bold; color: #d35400; margin-bottom: 5px;">
                            ${compositions[0] || 'Не определен'}
                        </div>
                        <div style="color: #856404;">
                            Оптимальный состав по совокупности характеристик
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики -->
            ${chartImages.comparisonChart || chartImages.differenceChart ? `
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 13px; margin: 0 0 12px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    📊 ГРАФИЧЕСКОЕ СРАВНЕНИЕ
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${chartImages.comparisonChart ? `
                    <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #555;">Сравнение параметров</div>
                        <img src="${chartImages.comparisonChart}" style="
                            width: 100%;
                            max-width: 240px;
                            height: auto;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        " />
                    </div>
                    ` : ''}
                    
                    ${chartImages.differenceChart ? `
                    <div style="text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #555;">Различия, %</div>
                        <img src="${chartImages.differenceChart}" style="
                            width: 100%;
                            max-width: 240px;
                            height: auto;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        " />
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            <!-- Рейтинги в одну строку -->
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 13px; margin: 0 0 12px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    🏆 РЕЙТИНГ КАЧЕСТВА
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    ${compositions.map((comp, index) => {
                        const score = (8.5 - index * 0.3).toFixed(1);
                        return `
                        <div style="
                            background: white;
                            padding: 10px;
                            border-radius: 5px;
                            border: 1px solid #e9ecef;
                            text-align: center;
                        ">
                            <div style="font-size: 14px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">
                                ${score}/10
                            </div>
                            <div style="font-size: 10px; color: #666; height: 30px; overflow: hidden;">
                                ${comp.length > 25 ? comp.substring(0, 25) + '...' : comp}
                            </div>
                            <div style="background: #ecf0f1; height: 4px; border-radius: 2px; margin-top: 5px;">
                                <div style="
                                    background: ${getScoreColor(score)};
                                    height: 100%;
                                    width: ${(parseFloat(score) * 10)}%;
                                    border-radius: 2px;
                                "></div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Детальная таблица -->
            <div style="margin-bottom: 15px;">
                <h3 style="font-size: 13px; margin: 0 0 10px 0; color: #333; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    📈 ТАБЛИЦА СРАВНЕНИЯ
                </h3>
                ${getCompactComparisonTable()}
            </div>

            <!-- Ключевые показатели -->
            <div style="
                background: #e8f5e8;
                padding: 12px;
                border-radius: 5px;
                border-left: 3px solid #27ae60;
                margin-bottom: 15px;
            ">
                <h3 style="font-size: 13px; margin: 0 0 8px 0; color: #2d5016; font-weight: bold;">
                    ✅ КЛЮЧЕВЫЕ ВЫВОДЫ
                </h3>
                <div style="font-size: 11px; color: #2d5016;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 3px;">Лучший по теплоте:</div>
                            <div>${compositions[0] || 'Н/Д'}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 3px;">Экологичность:</div>
                            <div>${compositions[0] || 'Н/Д'}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Подвал -->
            <div style="
                text-align: center;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
                border-top: 1px solid #dee2e6;
                font-size: 10px;
                color: #666;
            ">
                Отчет сгенерирован автоматически • ${new Date().toLocaleString('ru-RU')}
            </div>
        </div>
    `;
}

function getCompactComparisonTable() {
    const table = document.querySelector('.comparison-table');
    if (!table) return '<div style="text-align: center; color: #999; padding: 20px; font-size: 11px;">Нет данных для отображения</div>';
    
    // Создаем компактную версию таблицы
    const clonedTable = table.cloneNode(true);
    
    // Применяем компактные стили
    clonedTable.style.width = '100%';
    clonedTable.style.borderCollapse = 'collapse';
    clonedTable.style.fontSize = '10px';
    clonedTable.style.lineHeight = '1.2';
    
    // Стили для заголовков
    const headers = clonedTable.querySelectorAll('th');
    headers.forEach(header => {
        header.style.background = '#34495e';
        header.style.color = 'white';
        header.style.padding = '6px 4px';
        header.style.border = '1px solid #2c3e50';
        header.style.fontWeight = '600';
        header.style.fontSize = '10px';
    });
    
    // Стили для ячеек
    const cells = clonedTable.querySelectorAll('td');
    cells.forEach((cell, index) => {
        cell.style.padding = '4px';
        cell.style.border = '1px solid #dee2e6';
        cell.style.fontSize = '9px';
        
        // Чередование цветов строк
        const rowIndex = Math.floor(index / headers.length);
        if (rowIndex % 2 === 0) {
            cell.style.background = '#f8f9fa';
        }
        
        // Обрезаем длинный текст
        if (cell.textContent.length > 50) {
            cell.textContent = cell.textContent.substring(0, 50) + '...';
        }
    });
    
    return clonedTable.outerHTML;
}

function getScoreColor(score) {
    const numScore = parseFloat(score);
    if (numScore >= 8) return '#27ae60';
    if (numScore >= 7) return '#f39c12';
    return '#e74c3c';
}

function getChartImages() {
    const images = {
        comparisonChart: null,
        differenceChart: null
    };
    
    try {
        if (comparisonChart) {
            images.comparisonChart = comparisonChart.toBase64Image();
        }
        if (differenceChart) {
            images.differenceChart = differenceChart.toBase64Image();
        }
    } catch (error) {
        console.error('Ошибка получения графиков:', error);
    }
    
    return images;
}

function exportToCSV() {
    exportToExcel(); // Используем ту же реализацию
}

// Управление историей
function saveComparisonToHistory() {
    if (!currentComparisonData) {
        showNotification('Нет данных для сохранения', 'warning');
        return;
    }
    
    const selectedCompositions = Array.from(document.querySelectorAll('#compositionSelectors select'))
        .map(select => select.value)
        .filter(val => val);
    
    const historyItem = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('ru-RU'),
        compositions: selectedCompositions,
        data: currentComparisonData
    };
    
    comparisonHistory.unshift(historyItem);
    if (comparisonHistory.length > 10) {
        comparisonHistory = comparisonHistory.slice(0, 10);
    }
    
    localStorage.setItem('comparisonHistory', JSON.stringify(comparisonHistory));
    loadComparisonHistory();
    showNotification('Сравнение сохранено в историю', 'success');
}

function loadComparisonHistory() {
    const container = document.getElementById('comparisonHistory');
    
    if (comparisonHistory.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">История сравнений пуста</p>';
        return;
    }
    
    container.innerHTML = comparisonHistory.map(item => `
        <div class="card mb-2">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <strong class="d-block">${item.compositions.slice(0, 2).join(' vs ')}</strong>
                        <small class="text-muted">${item.timestamp}</small>
                        ${item.compositions.length > 2 ? 
                            `<small class="text-info d-block">+${item.compositions.length - 2} составов</small>` : ''
                        }
                    </div>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadFromHistory(${item.id})">
                        <i class="fas fa-redo me-1"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function loadFromHistory(id) {
    const item = comparisonHistory.find(h => h.id === id);
    if (item) {
        // Заполняем форму значениями из истории
        item.compositions.forEach((comp, index) => {
            const select = document.querySelector(`select[name="comp${index + 1}"]`);
            if (select) {
                select.value = comp;
            }
        });
        
        currentComparisonData = item.data;
        displayComparisonResults(item.data);
        showNotification('Сравнение загружено из истории', 'info');
    }
}

function clearHistory() {
    if (confirm('Очистить всю историю сравнений?')) {
        comparisonHistory = [];
        localStorage.setItem('comparisonHistory', JSON.stringify(comparisonHistory));
        loadComparisonHistory();
        showNotification('История очищена', 'warning');
    }
}

function toggleChartsView() {
    const chartsContainer = document.getElementById('visualComparison');
    const isDetailed = chartsContainer.classList.contains('detailed-view');
    
    if (isDetailed) {
        chartsContainer.classList.remove('detailed-view');
        chartsContainer.innerHTML = `
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light"><h6 class="mb-0">Сравнительная диаграмма</h6></div>
                    <div class="card-body"><canvas id="comparisonChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light"><h6 class="mb-0">Различия в процентах</h6></div>
                    <div class="card-body"><canvas id="differenceChart"></canvas></div>
                </div>
            </div>
        `;
        createVisualizations(currentComparisonData);
    } else {
        chartsContainer.classList.add('detailed-view');
        chartsContainer.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light"><h6 class="mb-0">Детальный анализ - Радарная диаграмма</h6></div>
                    <div class="card-body">
                        <canvas id="radarChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        `;
        // Создаем радарную диаграмму
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['Теплота', 'Зольность', 'Плотность', 'Горение', 'Эмиссии', 'Прочность'],
                datasets: [{
                    label: 'Состав 1',
                    data: [85, 95, 80, 75, 90, 85],
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }, {
                    label: 'Состав 2',
                    data: [75, 85, 90, 80, 70, 75],
                    fill: true,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgb(255, 99, 132)',
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 99, 132)'
                }]
            },
            options: {
                elements: {
                    line: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    showNotification('Вид графиков изменен', 'info');
}

// Улучшенная система уведомлений в правом нижнем углу
function showNotification(message, type = 'info') {
    // Создаем новый toast для каждого уведомления
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
            <div class="toast-header">
                <strong class="me-auto">${getNotificationTitle(type)}</strong>
                <small>${new Date().toLocaleTimeString('ru-RU')}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // Создаем или находим контейнер для тостов
    let toastContainer = document.querySelector('.toast-container-right');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '11';
        document.body.appendChild(toastContainer);
    }
    
    // Добавляем новый toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Показываем toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    
    // Устанавливаем класс в зависимости от типа
    const typeConfig = {
        'success': 'text-bg-success',
        'danger': 'text-bg-danger', 
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    };
    
    toastElement.classList.add(typeConfig[type] || typeConfig.info);
    
    toast.show();
    
    // Удаляем toast после скрытия
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function getNotificationTitle(type) {
    const titles = {
        'success': '✅ Успех',
        'danger': '❌ Ошибка',
        'warning': '⚠️ Предупреждение', 
        'info': 'ℹ️ Информация'
    };
    return titles[type] || titles.info;
}

</script>
{% endblock %}