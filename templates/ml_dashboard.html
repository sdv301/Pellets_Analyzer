<!-- templates/ml_dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- –•–µ–¥–µ—Ä -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg bg-gradient-primary1 text-white">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-6 fw-bold mb-2">ü§ñ ML –ê–Ω–∞–ª–∏–∑ –ü–µ–ª–ª–µ—Ç</h1>
                            <p class="lead mb-0 opacity-8">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–≤–æ–π—Å—Ç–≤</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="bg-dark-subtle bg-opacity-10 rounded-pill px-3 py-2 d-inline-block">
                                <i class="fas fa-brain me-2"></i>
                                <span id="modelsCount">0</span> –º–æ–¥–µ–ª–µ–π –æ–±—É—á–µ–Ω–æ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-info1 rounded-circle p-3 text-center">
                                <i class="fas fa-database text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–î–∞–Ω–Ω—ã–µ</h6>
                            <h4 class="mb-0" id="dataCount">0</h4>
                            <small class="text-success">–∑–∞–ø–∏—Å–µ–π</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-success1 rounded-circle p-3 text-center">
                                <i class="fas fa-cogs text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–ú–æ–¥–µ–ª–∏</h6>
                            <h4 class="mb-0" id="activeModels">0</h4>
                            <small class="text-success">–∞–∫—Ç–∏–≤–Ω—ã—Ö</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-warning1 rounded-circle p-3 text-center">
                                <i class="fas fa-bolt text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–¢–æ—á–Ω–æ—Å—Ç—å</h6>
                            <h4 class="mb-0" id="avgAccuracy">0%</h4>
                            <small class="text-success">R¬≤ score</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-danger1 rounded-circle p-3 text-center">
                                <i class="fas fa-rocket text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</h6>
                            <h4 class="mb-0" id="optimizations">0</h4>
                            <small class="text-success">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
          <!-- –§–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-0">
                        <h5 class="mb-0 text-gradient1 text-primary">
                            <i class="fas fa-graduation-cap me-2"></i>–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="ml-training-form" class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">üéØ –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</label>
                                    <div id="selectedProperties" class="mb-3 d-flex flex-wrap gap-2">
                                        <div class="alert alert-info border-0 bg-white py-1 px-2 d-none" id="noPropertiesSelected">
                                            <small>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–≤–æ–π—Å—Ç–≤–æ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</label>
                                    <div class="col-12 mb-3">
                                        <label class="form-label fw-semibold">–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—É—á–µ–Ω–∏—è</label>
                                        <select class="form-select" name="algorithm" id="algorithmSelect">
                                            <option value="random_forest">Random Forest</option>
                                            <option value="gradient_boosting">Gradient Boosting</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="selectAllProperties">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="clearProperties">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                    </div>
                                    <div class="row g-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="ad" id="prop_ad">
                                                <label class="form-check-label" for="prop_ad">üå´Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–æ–ª—ã –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="q" id="prop_q">
                                                <label class="form-check-label" for="prop_q">üî• –¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è (–ú–î–∂/–∫–≥)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="density" id="prop_density">
                                                <label class="form-check-label" for="prop_density">‚öñÔ∏è –ü–ª–æ—Ç–Ω–æ—Å—Ç—å (–∫–≥/–º¬≥)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="kf" id="prop_kf">
                                                <label class="form-check-label" for="prop_kf">üìê –£–¥–∞—Ä–æ–ø—Ä–æ—á–Ω–æ—Å—Ç—å (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="kt" id="prop_kt">
                                                <label class="form-check-label" for="prop_kt">üìè –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–ª–µ–±–∞—Ç–µ–ª—å–Ω—ã–º –Ω–∞–≥—Ä—É–∑–∫–∞–º (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="h" id="prop_h">
                                                <label class="form-check-label" for="prop_h">üíß –ì–∏–≥—Ä–æ—Å–∫–æ–ø–∏—á–Ω–æ—Å—Ç—å (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="mass_loss" id="prop_mass_loss">
                                                <label class="form-check-label" for="prop_mass_loss">‚ö° –ü–æ—Ç–µ—Ä—è –º–∞—Å—Å—ã (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="tign" id="prop_tign">
                                                <label class="form-check-label" for="prop_tign">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–∂–∏–≥–∞–Ω–∏—è (¬∞–°)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="tb" id="prop_tb">
                                                <label class="form-check-label" for="prop_tb">üí• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã–≥–æ—Ä–∞–Ω–∏—è (¬∞–°)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="tau_d1" id="prop_tau_d1">
                                                <label class="form-check-label" for="prop_tau_d1">‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≥–∞–∑–æ—Ñ–∞–∑–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="tau_d2" id="prop_tau_d2">
                                                <label class="form-check-label" for="prop_tau_d2">‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="tau_b" id="prop_tau_b">
                                                <label class="form-check-label" for="prop_tau_b">‚è±Ô∏è –í—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è (—Å)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="co2" id="prop_co2">
                                                <label class="form-check-label" for="prop_co2">üå¨Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –¥–∏–æ–∫—Å–∏–¥–∞ —É–≥–ª–µ—Ä–æ–¥–∞ (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="co" id="prop_co">
                                                <label class="form-check-label" for="prop_co">üå¨Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –º–æ–Ω–æ–æ–∫—Å–∏–¥–∞ —É–≥–ª–µ—Ä–æ–¥–∞ (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="so2" id="prop_so2">
                                                <label class="form-check-label" for="prop_so2">üå´Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –æ–∫—Å–∏–¥–æ–≤ —Å–µ—Ä—ã (ppm)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="nox" id="prop_nox">
                                                <label class="form-check-label" for="prop_nox">üå´Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –æ–∫—Å–∏–¥–æ–≤ –∞–∑–æ—Ç–∞ (ppm)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="war" id="prop_war">
                                                <label class="form-check-label" for="prop_war">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="vd" id="prop_vd">
                                                <label class="form-check-label" for="prop_vd">üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ª–µ—Ç—É—á–∏—Ö –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="cd" id="prop_cd">
                                                <label class="form-check-label" for="prop_cd">‚ö´ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É–≥–ª–µ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="hd" id="prop_hd">
                                                <label class="form-check-label" for="prop_hd">üí® –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥–æ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="nd" id="prop_nd">
                                                <label class="form-check-label" for="prop_nd">üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–∑–æ—Ç–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="sd" id="prop_sd">
                                                <label class="form-check-label" for="prop_sd">üî• –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-check custom-checkbox">
                                                <input class="form-check-input property-checkbox" type="checkbox" name="target_properties[]" value="od" id="prop_od">
                                                <label class="form-check-label" for="prop_od">üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∏—Å–ª–æ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12 mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg w-100 py-3 fw-semibold border-0" disabled id="trainButton">
                                        <i class="fas fa-brain me-2"></i>
                                        <span class="btn-text">–û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å</span>
                                        <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è -->
                        <div id="trainingResults" class="mt-4" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-0">
                        <h5 class="mb-0 text-gradient1 text-success">
                            <i class="fas fa-magic me-2"></i>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–∞–≤–æ–≤
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="optimization-form" class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">üéØ –¶–µ–ª–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è</label>
                                    <select name="target_property" class="form-select form-select-lg border-0 bg-light" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...</option>
                                        <option value="q" data-icon="üî•">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ—Ç—É —Å–≥–æ—Ä–∞–Ω–∏—è (–ú–î–∂/–∫–≥)</option>
                                        <option value="density" data-icon="‚öñÔ∏è">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (–∫–≥/–º¬≥)</option>
                                        <option value="kf" data-icon="üìê">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞—Ä–æ–ø—Ä–æ—á–Ω–æ—Å—Ç—å (%)</option>
                                        <option value="kt" data-icon="üìè">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–ª–µ–±–∞—Ç–µ–ª—å–Ω—ã–º –Ω–∞–≥—Ä—É–∑–∫–∞–º (%)</option>
                                        <option value="vd" data-icon="üå¨Ô∏è">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ª–µ—Ç—É—á–∏—Ö –≤–µ—â–µ—Å—Ç–≤ (%)</option>
                                        <option value="cd" data-icon="‚ö´">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É–≥–ª–µ—Ä–æ–¥–∞ (%)</option>
                                        <option value="hd" data-icon="üí®">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥–æ—Ä–æ–¥–∞ (%)</option>
                                        <option value="tign" data-icon="üå°Ô∏è">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑–∞–∂–∏–≥–∞–Ω–∏—è (¬∞–°)</option>
                                        <option value="tb" data-icon="üí•">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≤—ã–≥–æ—Ä–∞–Ω–∏—è (¬∞–°)</option>
                                        <option value="tau_b" data-icon="‚è±Ô∏è">–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è (—Å)</option>
                                        <option value="ad" data-icon="üå´Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–æ–ª—ã (%)</option>
                                        <option value="h" data-icon="üíß">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–∏–≥—Ä–æ—Å–∫–æ–ø–∏—á–Ω–æ—Å—Ç—å (%)</option>
                                        <option value="mass_loss" data-icon="‚ö°">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–µ—Ä—é –º–∞—Å—Å—ã (%)</option>
                                        <option value="war" data-icon="üíß">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å (%)</option>
                                        <option value="nd" data-icon="üå¨Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–∑–æ—Ç–∞ (%)</option>
                                        <option value="sd" data-icon="üî•">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã (%)</option>
                                        <option value="od" data-icon="üå¨Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∏—Å–ª–æ—Ä–æ–¥–∞ (%)</option>
                                        <option value="co2" data-icon="üå¨Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é CO‚ÇÇ (%)</option>
                                        <option value="co" data-icon="üå¨Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é CO (%)</option>
                                        <option value="so2" data-icon="üå´Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é SO‚ÇÇ (ppm)</option>
                                        <option value="nox" data-icon="üå´Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é NOx (ppm)</option>
                                        <option value="tau_d1" data-icon="‚è±Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≥–∞–∑–æ—Ñ–∞–∑–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)</option>
                                        <option value="tau_d2" data-icon="‚è±Ô∏è">–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-semibold">üìà –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</label>
                                    <select name="maximize" class="form-select form-select-lg border-0 bg-light">
                                        <option value="true">üìà –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å</option>
                                        <option value="false">üìâ –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="advancedConstraints" name="advanced_constraints">
                                        <label class="form-check-label" for="advancedConstraints">
                                            <i class="fas fa-cog me-1"></i>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                                        </label>
                                    </div>
                                </div>

                                <div id="constraintsSection" class="col-12" style="display: none;">
                                    <label class="form-label fw-semibold">üîß –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (%)</label>
                                    <div class="row g-2">
                                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ JS -->
                                    </div>
                                </div>

                                <div class="col-12 mt-2">
                                    <button type="submit" class="btn btn-success btn-lg w-100 py-3 fw-semibold border-0">
                                        <i class="fas fa-bolt me-2"></i>
                                        <span class="btn-text">–ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤</span>
                                        <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
                        <div id="optimizationResults" class="mt-4" style="display: none;"></div>
                    </div>
                </div>
            </div>

    <!-- –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-gradient1 text-info">
                        <i class="fas fa-chart-line me-2"></i>–°—Ç–∞—Ç—É—Å ML –º–æ–¥–µ–ª–µ–π
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshModels">
                        <i class="fas fa-sync-alt me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="card-body">
                    <div id="mlSystemStatus" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–µ–ª–µ–π...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∏–ª–∏ -->
<style>
.custom-checkbox .form-check-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}
.custom-checkbox .form-check-label {
    position: relative;
    padding-left: 25px; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞ –∏ –≥–∞–ª–æ—á–∫–∏ */
    cursor: pointer;
}
.custom-checkbox .form-check-label::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid #ced4da; /* –†–∞–º–∫–∞ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞ */
    background-color: #fff;
    transition: background-color 0.2s ease, border-color 0.2s ease;
}
.custom-checkbox .form-check-input:checked ~ .form-check-label::before {
    background-color: #28a745; /* –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ */
    border-color: #28a745;
}
.custom-checkbox .form-check-label::after {
    content: '‚úì'; /* –ì–∞–ª–æ—á–∫–∞ */
    position: absolute;
    left: 2px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: #fff;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.custom-checkbox .form-check-input:checked ~ .form-check-label::after {
    opacity: 1;
}
.alert-info, .alert-warning {
    background-color: #ffffff !important;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    color: #333;
}
.alert-info i {
    color: #667eea;
}
.alert-warning i {
    color: #fa709a;
}
.badge {
    font-size: 0.7rem;
    padding: 0.5em 0.8em;
}
.btn-close-white {
    filter: invert(100%);
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
.hover-lift {
    transition: all 0.3s ease;
}
.hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.text-gradient1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.bg-gradient-primary1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-info1 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.bg-gradient-success1 {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
}

.bg-gradient-warning1 {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;
}

.bg-gradient-danger1 {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%) !important;
}

.card {
    border-radius: 16px !important;
}

.form-select, .form-control {
    border-radius: 12px !important;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn {
    border-radius: 12px !important;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.model-card {
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
}

.model-card:hover {
    background-color: #f8f9fe;
}

.progress {
    border-radius: 10px;
    height: 8px;
}

.progress-bar {
    border-radius: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadMLStatus();
    updateSystemStats();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('ml-training-form').addEventListener('submit', handleMLTraining);
    document.getElementById('optimization-form').addEventListener('submit', handleOptimization);
    document.getElementById('refreshModels').addEventListener('click', loadMLStatus);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å–≤–æ–π—Å—Ç–≤
    initSelectEnhancements();
    initConstraintsSection();
    initTrainingForm();
});

function initSelectEnhancements() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ —Ç–æ–ª—å–∫–æ –∫ select –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    const select = document.querySelector('select[name="target_property"]');
    if (select) {
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const icon = selectedOption.getAttribute('data-icon');
            if (icon) {
                this.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg>${encodeURIComponent(icon)}</svg>')`;
            }
        });
    }
}

function initConstraintsSection() {
    const advancedConstraints = document.getElementById('advancedConstraints');
    const constraintsSection = document.getElementById('constraintsSection');
    
    advancedConstraints.addEventListener('change', function() {
        constraintsSection.style.display = this.checked ? 'block' : 'none';
        if (this.checked) {
            fetch('/ml_system_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.system_status.available_components.length > 0) {
                        const constraintsContainer = constraintsSection.querySelector('.row');
                        constraintsContainer.innerHTML = '';
                        data.system_status.available_components.forEach(comp => {
                            constraintsContainer.innerHTML += `
                                <div class="col-12">
                                    <div class="card bg-light border-0 p-2">
                                        <label class="form-label mb-1">${comp}</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <input type="number" name="min_${comp}" class="form-control" placeholder="–ú–∏–Ω. %" min="0" max="100" step="0.1" value="0" required>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" name="max_${comp}" class="form-control" placeholder="–ú–∞–∫—Å. %" min="0" max="100" step="0.1" value="100" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
        }
    });
}

function initTrainingForm() {
    const selectedPropertiesContainer = document.getElementById('selectedProperties');
    const noPropertiesSelected = document.getElementById('noPropertiesSelected');
    const trainButton = document.getElementById('trainButton');
    const selectAllButton = document.getElementById('selectAllProperties');
    const clearButton = document.getElementById('clearProperties');
    const checkboxes = document.querySelectorAll('.property-checkbox');

    function updateSelectedProperties() {
        selectedPropertiesContainer.innerHTML = '';
        const checked = document.querySelectorAll('.property-checkbox:checked');
        
        if (checked.length === 0) {
            noPropertiesSelected.classList.remove('d-none');
            trainButton.disabled = true;
        } else {
            noPropertiesSelected.classList.add('d-none');
            trainButton.disabled = false;
            checked.forEach(checkbox => {
                const value = checkbox.value;
                const label = checkbox.nextElementSibling.textContent;
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.innerHTML = `
                    ${label}
                    <button type="button" class="btn-close btn-close-white ms-1" aria-label="Remove" data-value="${value}"></button>
                `;
                selectedPropertiesContainer.appendChild(badge);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
        document.querySelectorAll('.btn-close').forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const checkbox = document.querySelector(`.property-checkbox[value="${value}"]`);
                checkbox.checked = false;
                updateSelectedProperties();
            });
        });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedProperties);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    selectAllButton.addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedProperties();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–û—á–∏—Å—Ç–∏—Ç—å"
    clearButton.addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedProperties();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateSelectedProperties();
}

function updateSystemStats() {
    fetch('/ml_system_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modelsCount').textContent = data.system_status.trained_models.length;
                document.getElementById('activeModels').textContent = data.system_status.trained_models.length;
                document.getElementById('dataCount').textContent = data.system_status.training_data_size;
                
                let totalR2 = 0;
                let count = 0;
                Object.values(data.system_status.model_metrics).forEach(model => {
                    if (model.training_metrics.r2_score) {
                        totalR2 += model.training_metrics.r2_score;
                        count++;
                    }
                });
                const avgAccuracy = count > 0 ? (totalR2 / count * 100).toFixed(1) : 0;
                document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
                document.getElementById('optimizations').textContent = data.system_status.ml_optimizations_count;
            }
        });
}

function loadMLStatus() {
    const statusContainer = document.getElementById('mlSystemStatus');
    statusContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–µ–ª–µ–π...</p>
        </div>
    `;
    
    fetch('/ml_system_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';
                
                if (data.system_status.trained_models.length > 0) {
                    html = '<div class="row g-3">';
                    for (const prop of data.system_status.trained_models) {
                        const metrics = data.system_status.model_metrics[prop].training_metrics;
                        const r2Percent = (metrics.r2_score * 100).toFixed(1);
                        const maeValue = metrics.mae?.toFixed(3) || 'N/A';
                        const displayName = data.system_status.model_metrics[prop].display_name;
                        
                        html += `
                            <div class="col-xl-4 col-md-6">
                                <div class="card model-card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h6 class="fw-bold text-primary mb-0">${displayName}</h6>
                                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small class="text-muted">–¢–æ—á–Ω–æ—Å—Ç—å (R¬≤)</small>
                                                <small class="fw-bold">${r2Percent}%</small>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: ${r2Percent}%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <small class="text-muted d-block">MAE</small>
                                                <strong class="text-dark">${maeValue}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">–û–±—É—á–µ–Ω–∞</small>
                                                <strong class="text-dark">‚úì</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                } else {
                    html = `
                        <div class="text-center py-5">
                            <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">–ú–æ–¥–µ–ª–∏ –Ω–µ –æ–±—É—á–µ–Ω—ã</h5>
                            <p class="text-muted mb-3">–û–±—É—á–∏—Ç–µ –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                            <div class="alert alert-info border-0 bg-white">
                                <i class="fas fa-lightbulb me-2"></i>
                                <small>–î–ª—è –æ–±—É—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ—Å—Ç–∞–≤—ã</small>
                            </div>
                        </div>
                    `;
                }
                
                statusContainer.innerHTML = html;
                updateSystemStats();
            } else {
                statusContainer.innerHTML = `
                    <div class="alert alert-warning border-0 bg-white">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `
                <div class="alert alert-warning border-0 bg-white">
                    <i class="fas fa-wifi me-2"></i>
                    –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                </div>
            `;
        });
}

function handleMLTraining(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btnText.textContent = '–û–±—É—á–µ–Ω–∏–µ...';
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    const algorithm = document.getElementById('algorithmSelect').value;
    formData.append('algorithm', algorithm);  // –î–æ–±–∞–≤–ª—è–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º –≤ FormData
    
    fetch('/ml_system_train', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsContainer = document.getElementById('trainingResults');
        resultsContainer.style.display = 'block';
        
        if (data.success) {
            resultsContainer.innerHTML = `
                <div class="alert alert-info border-0 bg-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x text-primary me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞!</h5>
                            <p class="mb-1">${data.message}</p>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <strong>R¬≤ Score:</strong> ${(data.metrics[data.status.trained_models[0]]?.r2_score || 0).toFixed(3)}
                                </div>
                                <div class="col-6">
                                    <strong>MAE:</strong> ${(data.metrics[data.status.trained_models[0]]?.mae || 'N/A')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadMLStatus();
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning border-0 bg-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è</h5>
                            <p class="mb-0">${data.error}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('trainingResults').innerHTML = `
            <div class="alert alert-warning border-0 bg-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wifi fa-2x text-warning me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                </div>
            </div>
        `;
    })
    .finally(() => {
        btnText.textContent = '–û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å';
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    });
}

function handleOptimization(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btnText.textContent = '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è...';
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    
    fetch('/ml_optimize', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsContainer = document.getElementById('optimizationResults');
        resultsContainer.style.display = 'block';
        
        if (data.success) {
            let compositionHtml = '<div class="mt-3"><h6>üß© –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤:</h6><div class="row g-2">';
            for (const [comp, percent] of Object.entries(data.optimal_composition)) {
                if (percent > 0.1) {
                    compositionHtml += `
                        <div class="col-6">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold">${comp}</span>
                                        <span class="badge bg-primary">${percent.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            compositionHtml += '</div></div>';
            
            resultsContainer.innerHTML = `
                <div class="alert alert-info border-0 bg-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-bolt fa-2x text-warning me-3"></i>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h5>
                            <p class="mb-2"><strong>üéØ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</strong> ${data.optimal_value?.toFixed(3)}</p>
                            ${compositionHtml}
                            <p class="mt-2"><strong>–£–ª—É—á—à–µ–Ω–∏–µ:</strong> ${data.improvement?.toFixed(2) || 'N/A'}</p>
                            <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–æ/–∏–∑–º–µ–Ω–µ–Ω–æ:</strong> ${data.added_components?.join(', ') || '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π'}</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning border-0 bg-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h5>
                            <p class="mb-0">${data.error}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('optimizationResults').innerHTML = `
            <div class="alert alert-warning border-0 bg-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wifi fa-2x text-warning me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                </div>
            </div>
        `;
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        btnText.textContent = '–ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤';
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    });
}

function getPropertyDisplayName(prop) {
    const names = {
        'ad': 'üå´Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–æ–ª—ã –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'q': 'üî• –¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è (–ú–î–∂/–∫–≥)',
        'density': '‚öñÔ∏è –ü–ª–æ—Ç–Ω–æ—Å—Ç—å (–∫–≥/–º¬≥)',
        'kf': 'üìê –£–¥–∞—Ä–æ–ø—Ä–æ—á–Ω–æ—Å—Ç—å (%)',
        'kt': 'üìè –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–ª–µ–±–∞—Ç–µ–ª—å–Ω—ã–º –Ω–∞–≥—Ä—É–∑–∫–∞–º (%)',
        'h': 'üíß –ì–∏–≥—Ä–æ—Å–∫–æ–ø–∏—á–Ω–æ—Å—Ç—å (%)',
        'mass_loss': '‚ö° –ü–æ—Ç–µ—Ä—è –º–∞—Å—Å—ã (%)',
        'tign': 'üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–∂–∏–≥–∞–Ω–∏—è (¬∞–°)',
        'tb': 'üí• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã–≥–æ—Ä–∞–Ω–∏—è (¬∞–°)',
        'tau_d1': '‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≥–∞–∑–æ—Ñ–∞–∑–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)',
        'tau_d2': '‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ–≥–æ –∑–∞–∂–∏–≥–∞–Ω–∏—è (—Å)',
        'tau_b': '‚è±Ô∏è –í—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è (—Å)',
        'co2': 'üå¨Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –¥–∏–æ–∫—Å–∏–¥–∞ —É–≥–ª–µ—Ä–æ–¥–∞ (%)',
        'co': 'üå¨Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –º–æ–Ω–æ–æ–∫—Å–∏–¥–∞ —É–≥–ª–µ—Ä–æ–¥–∞ (%)',
        'so2': 'üå´Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –æ–∫—Å–∏–¥–æ–≤ —Å–µ—Ä—ã (ppm)',
        'nox': 'üå´Ô∏è –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –æ–∫—Å–∏–¥–æ–≤ –∞–∑–æ—Ç–∞ (ppm)',
        'war': 'üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –º–∞—Å—Å—É (%)',
        'vd': 'üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ª–µ—Ç—É—á–∏—Ö –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'cd': '‚ö´ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É–≥–ª–µ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'hd': 'üí® –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥–æ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'nd': 'üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–∑–æ—Ç–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'sd': 'üî• –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Ä—ã –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)',
        'od': 'üå¨Ô∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∏—Å–ª–æ—Ä–æ–¥–∞ –Ω–∞ —Å—É—Ö—É—é –º–∞—Å—Å—É (%)'
    };
    return names[prop] || prop;
}
</script>
{% endblock %}