<!-- templates/ml_dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- –•–µ–¥–µ—Ä -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg bg-gradient-primary1 text-white">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-6 fw-bold mb-2">ü§ñ ML –ê–Ω–∞–ª–∏–∑ –ü–µ–ª–ª–µ—Ç</h1>
                            <p class="lead mb-0 opacity-8">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–≤–æ–π—Å—Ç–≤</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="bg-white bg-opacity-10 rounded-pill px-3 py-2 d-inline-block">
                                <i class="fas fa-brain me-2"></i>
                                <span id="modelsCount">0</span> –º–æ–¥–µ–ª–µ–π –æ–±—É—á–µ–Ω–æ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-info1 rounded-circle p-3 text-center">
                                <i class="fas fa-database text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–î–∞–Ω–Ω—ã–µ</h6>
                            <h4 class="mb-0" id="dataCount">0</h4>
                            <small class="text-success">–∑–∞–ø–∏—Å–µ–π</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-success1 rounded-circle p-3 text-center">
                                <i class="fas fa-cogs text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–ú–æ–¥–µ–ª–∏</h6>
                            <h4 class="mb-0" id="activeModels">0</h4>
                            <small class="text-success">–∞–∫—Ç–∏–≤–Ω—ã—Ö</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-warning1 rounded-circle p-3 text-center">
                                <i class="fas fa-bolt text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–¢–æ—á–Ω–æ—Å—Ç—å</h6>
                            <h4 class="mb-0" id="avgAccuracy">0%</h4>
                            <small class="text-success">R¬≤ score</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3">
                            <div class="bg-gradient-danger1 rounded-circle p-3 text-center">
                                <i class="fas fa-rocket text-white fs-4"></i>
                            </div>
                        </div>
                        <div class="col-9">
                            <h6 class="text-muted mb-1">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</h6>
                            <h4 class="mb-0" id="optimizations">0</h4>
                            <small class="text-success">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="mb-0 text-gradient1 text-primary">
                        <i class="fas fa-graduation-cap me-2"></i>–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
                    </h5>
                </div>
                <div class="card-body">
                    <form id="ml-training-form" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">üéØ –¶–µ–ª–µ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ</label>
                                <select name="target_property" class="form-select form-select-lg border-0 bg-light" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞...</option>
                                    <option value="q" data-icon="üî•">–¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è (Q)</option>
                                    <option value="density" data-icon="‚öñÔ∏è">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å</option>
                                    <option value="ad" data-icon="üå´Ô∏è">–ó–æ–ª—å–Ω–æ—Å—Ç—å (Ad)</option>
                                    <option value="kf" data-icon="üìê">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ñ–æ—Ä–º—ã (Kf)</option>
                                    <option value="tign" data-icon="üå°Ô∏è">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ—Å–ø–ª–∞–º–µ–Ω–µ–Ω–∏—è</option>
                                    <option value="tb" data-icon="üí•">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–æ—Ä–µ–Ω–∏—è</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">‚öôÔ∏è –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—É—á–µ–Ω–∏—è</label>
                                <select name="algorithm" class="form-select form-select-lg border-0 bg-light">
                                    <option value="random_forest">üå≤ Random Forest (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                                    <option value="gradient_boosting">üöÄ Gradient Boosting</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="advancedSettings" name="advanced_settings">
                                    <label class="form-check-label" for="advancedSettings">
                                        <i class="fas fa-cog me-1"></i>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </label>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg w-100 py-3 fw-semibold border-0">
                                    <i class="fas fa-brain me-2"></i>
                                    <span class="btn-text">–û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å</span>
                                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è -->
                    <div id="trainingResults" class="mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="mb-0 text-gradient1 text-success">
                        <i class="fas fa-magic me-2"></i>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–∞–≤–æ–≤
                    </h5>
                </div>
                <div class="card-body">
                    <form id="optimization-form" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">üéØ –¶–µ–ª–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è</label>
                                <select name="target_property" class="form-select form-select-lg border-0 bg-light" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...</option>
                                    <option value="q">üî• –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ø–ª–æ—Ç—É —Å–≥–æ—Ä–∞–Ω–∏—è</option>
                                    <option value="ad">üå´Ô∏è –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–æ–ª—å–Ω–æ—Å—Ç—å</option>
                                    <option value="density">‚öñÔ∏è –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–æ—Ç–Ω–æ—Å—Ç—å</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">üìà –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</label>
                                <select name="maximize" class="form-select form-select-lg border-0 bg-light">
                                    <option value="true">üìà –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å (—É–≤–µ–ª–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ)</option>
                                    <option value="false">üìâ –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å (—É–º–µ–Ω—å—à–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ)</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <div class="alert alert-info border-0 bg-light">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏</small>
                                </div>
                            </div>

                            <div class="col-12 mt-2">
                                <button type="submit" class="btn btn-success btn-lg w-100 py-3 fw-semibold border-0">
                                    <i class="fas fa-bolt me-2"></i>
                                    <span class="btn-text">–ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤</span>
                                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
                    <div id="optimizationResults" class="mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-gradient1 text-info">
                        <i class="fas fa-chart-line me-2"></i>–°—Ç–∞—Ç—É—Å ML –º–æ–¥–µ–ª–µ–π
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refreshModels">
                        <i class="fas fa-sync-alt me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div class="card-body">
                    <div id="mlSystemStatus" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–µ–ª–µ–π...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∏–ª–∏ -->
<style>
.hover-lift {
    transition: all 0.3s ease;
}
.hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.text-gradient1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.bg-gradient-primary1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-info1 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.bg-gradient-success1 {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
}

.bg-gradient-warning1 {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;
}

.bg-gradient-danger1 {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%) !important;
}

.card {
    border-radius: 16px !important;
}

.form-select, .form-control {
    border-radius: 12px !important;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn {
    border-radius: 12px !important;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.model-card {
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
}

.model-card:hover {
    background-color: #f8f9fe;
}

.progress {
    border-radius: 10px;
    height: 8px;
}

.progress-bar {
    border-radius: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadMLStatus();
    updateSystemStats();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('ml-training-form').addEventListener('submit', handleMLTraining);
    document.getElementById('optimization-form').addEventListener('submit', handleOptimization);
    document.getElementById('refreshModels').addEventListener('click', loadMLStatus);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å–≤–æ–π—Å—Ç–≤
    initSelectEnhancements();
});

function initSelectEnhancements() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –∫ –æ–ø—Ü–∏—è–º select
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const icon = selectedOption.getAttribute('data-icon');
            if (icon) {
                this.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg>${icon}</svg>')`;
            }
        });
    });
}

function updateSystemStats() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
    fetch('/ml_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modelsCount').textContent = data.models_trained;
                document.getElementById('activeModels').textContent = data.models_trained;
                document.getElementById('dataCount').textContent = '33'; // –ò–∑ –≤–∞—à–µ–≥–æ –ª–æ–≥–∞
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Ç–æ—á–Ω–æ—Å—Ç—å
                let totalR2 = 0;
                let count = 0;
                Object.values(data.model_status).forEach(model => {
                    if (model.r2_score) {
                        totalR2 += model.r2_score;
                        count++;
                    }
                });
                const avgAccuracy = count > 0 ? (totalR2 / count * 100).toFixed(1) : 0;
                document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
            }
        });
}

function loadMLStatus() {
    const statusContainer = document.getElementById('mlSystemStatus');
    statusContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–µ–ª–µ–π...</p>
        </div>
    `;
    
    fetch('/ml_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';
                
                if (data.models_trained > 0) {
                    html = '<div class="row g-3">';
                    for (const [prop, status] of Object.entries(data.model_status)) {
                        const r2Percent = (status.r2_score * 100).toFixed(1);
                        const maeValue = status.mae?.toFixed(3) || 'N/A';
                        
                        html += `
                            <div class="col-xl-4 col-md-6">
                                <div class="card model-card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h6 class="fw-bold text-primary mb-0">${getPropertyDisplayName(prop)}</h6>
                                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small class="text-muted">–¢–æ—á–Ω–æ—Å—Ç—å (R¬≤)</small>
                                                <small class="fw-bold">${r2Percent}%</small>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: ${r2Percent}%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <small class="text-muted d-block">MAE</small>
                                                <strong class="text-dark">${maeValue}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted d-block">–û–±—É—á–µ–Ω–∞</small>
                                                <strong class="text-dark">‚úì</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                } else {
                    html = `
                        <div class="text-center py-5">
                            <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">–ú–æ–¥–µ–ª–∏ –Ω–µ –æ–±—É—á–µ–Ω—ã</h5>
                            <p class="text-muted mb-3">–û–±—É—á–∏—Ç–µ –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                            <div class="alert alert-info border-0 bg-light">
                                <i class="fas fa-lightbulb me-2"></i>
                                <small>–î–ª—è –æ–±—É—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ—Å—Ç–∞–≤—ã</small>
                            </div>
                        </div>
                    `;
                }
                
                statusContainer.innerHTML = html;
                updateSystemStats();
            } else {
                statusContainer.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-wifi me-2"></i>
                    –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                </div>
            `;
        });
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ handleMLTraining –∏ handleOptimization –æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
// –Ω–æ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º UI –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑—å—é

function handleMLTraining(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btnText.textContent = '–û–±—É—á–µ–Ω–∏–µ...';
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    
    fetch('/ml_training', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsContainer = document.getElementById('trainingResults');
        resultsContainer.style.display = 'block';
        
        if (data.success) {
            resultsContainer.innerHTML = `
                <div class="alert alert-success border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞!</h5>
                            <p class="mb-1">${data.message}</p>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <strong>R¬≤ Score:</strong> ${data.r2_score?.toFixed(3) || 'N/A'}
                                </div>
                                <div class="col-6">
                                    <strong>MAE:</strong> ${data.mae?.toFixed(3) || 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadMLStatus();
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è</h5>
                            <p class="mb-0">${data.error}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('trainingResults').innerHTML = `
            <div class="alert alert-danger border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wifi fa-2x text-danger me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                </div>
            </div>
        `;
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        btnText.textContent = '–û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å';
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    });
}

function handleOptimization(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btnText.textContent = '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è...';
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(form);
    
    fetch('/optimize', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsContainer = document.getElementById('optimizationResults');
        resultsContainer.style.display = 'block';
        
        if (data.success) {
            let compositionHtml = '<div class="mt-3"><h6>üß© –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤:</h6><div class="row g-2">';
            for (const [comp, percent] of Object.entries(data.optimal_composition)) {
                if (percent > 0.1) {
                    compositionHtml += `
                        <div class="col-6">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold">${comp}</span>
                                        <span class="badge bg-primary">${percent.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            compositionHtml += '</div></div>';
            
            resultsContainer.innerHTML = `
                <div class="alert alert-success border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-bolt fa-2x text-warning me-3"></i>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-1">‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h5>
                            <p class="mb-2"><strong>üéØ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</strong> ${data.predicted_value?.toFixed(3)}</p>
                            ${compositionHtml}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h5>
                            <p class="mb-0">${data.error}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('optimizationResults').innerHTML = `
            <div class="alert alert-danger border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wifi fa-2x text-danger me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h5>
                        <p class="mb-0">${error.message}</p>
                    </div>
                </div>
            </div>
        `;
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        btnText.textContent = '–ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤';
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    });
}

function getPropertyDisplayName(prop) {
    const names = {
        'q': 'üî• –¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è',
        'density': '‚öñÔ∏è –ü–ª–æ—Ç–Ω–æ—Å—Ç—å', 
        'ad': 'üå´Ô∏è –ó–æ–ª—å–Ω–æ—Å—Ç—å',
        'kf': 'üìê –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ñ–æ—Ä–º—ã',
        'tign': 'üå°Ô∏è –¢–µ–º–ø. –≤–æ—Å–ø–ª–∞–º–µ–Ω–µ–Ω–∏—è',
        'tb': 'üí• –¢–µ–º–ø. –≥–æ—Ä–µ–Ω–∏—è'
    };
    return names[prop] || prop;
}
</script>
{% endblock %}