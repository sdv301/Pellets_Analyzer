{% extends "base.html" %}

{% block content %}
<div id="create-graph-page" class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="card border-radius-lg shadow-sm mb-4">
                <div class="card-header pb-3 bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π</h4>
                            <p class="text-sm text-muted mb-0">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ–ª–ª–µ—Ç–∞—Ö</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm border-radius-lg" id="helpBtn">
                                <i class="fas fa-question-circle me-1"></i>–ü–æ–º–æ—â—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row h-80">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="col-lg-4 h-100 d-flex flex-column">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä–∞—Ñ–∏–∫–∞ -->
                    <div class="card border-radius-lg shadow-sm flex-shrink-0" style="flex: 0 0 65%;">
                        <div class="card-header bg-gradient-primary text-white border-radius-lg-top">
                            <h5 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞</h5>
                        </div>
                        <div class="card-body p-3 d-flex flex-column">
                            <form id="graph-form" class="h-100 d-flex flex-column" onsubmit="return false;">
                                <div style="flex: 1; overflow-y: auto;">
                                    <!-- –¢–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≥—Ä–∞—Ñ–∏–∫ -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">–¢–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:</label>
                                            <select name="viz_type" class="form-select border-radius-lg" id="vizType">
                                                <option value="matplotlib">Matplotlib (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ)</option>
                                                <option value="plotly">Plotly (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ)</option>
                                                <option value="seaborn">Seaborn (—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞:</label>
                                            <select name="graph_type" class="form-select border-radius-lg" id="graphType">
                                                <option value="scatter">–¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
                                                <option value="line">–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</option>
                                                <option value="bar">–°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
                                                <option value="histogram">–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞</option>
                                                <option value="box">Box Plot</option>
                                                <option value="violin">Violin Plot</option>
                                                <option value="pie">–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
                                                <option value="heatmap">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                                                <option value="radar">–†–∞–¥–∞—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
                                                <option value="sunburst">Sunburst</option>
                                                <option value="treemap">Treemap</option>
                                                <option value="3d_scatter">3D Scatter</option>
                                                <option value="animated_scatter">–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">–ü–∞—Ä–∞–º–µ—Ç—Ä X:</label>
                                            <select name="x_param" class="form-select border-radius-lg" id="xParam">
                                                {% for param in parameters %}
                                                    <option value="{{ param }}" {% if param == 'ad' %}selected{% endif %}>
                                                        {{ param }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">–ü–∞—Ä–∞–º–µ—Ç—Ä Y:</label>
                                            <select name="y_param" class="form-select border-radius-lg" id="yParam">
                                                {% for param in parameters %}
                                                    <option value="{{ param }}" {% if param == 'q' %}selected{% endif %}>
                                                        {{ param }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä Z (–¥–ª—è 3D):</label>
                                            <select name="z_param" class="form-select border-radius-lg" id="zParam">
                                                <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                                {% for param in parameters %}
                                                    <option value="{{ param }}">{{ param }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:</label>
                                            <select name="color_param" class="form-select border-radius-lg" id="colorParam">
                                                <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                                {% for param in parameters %}
                                                    <option value="{{ param }}">{{ param }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- –û–ø—Ü–∏–∏ –¥–ª—è Plotly -->
                                    <div id="plotlyOptions" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä —Ä–∞–∑–º–µ—Ä–∞:</label>
                                                <select name="size_param" class="form-select border-radius-lg">
                                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                                    {% for param in parameters %}
                                                        <option value="{{ param }}">{{ param }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä –∞–Ω–∏–º–∞—Ü–∏–∏:</label>
                                                <select name="animation_param" class="form-select border-radius-lg">
                                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                                    {% for param in parameters %}
                                                        <option value="{{ param }}">{{ param }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label">–¢–µ–º–∞:</label>
                                            <select name="theme" class="form-select border-radius-lg">
                                                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</option>
                                                <option value="dark">–¢–µ–º–Ω–∞—è</option>
                                                <option value="seaborn">Seaborn</option>
                                                <option value="ggplot">ggplot</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">–°–µ—Ç–∫–∞:</label>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" name="show_grid" id="showGrid" checked>
                                                <label class="form-check-label" for="showGrid">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ—Ç–∫—É</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- –†–∞–∑–º–µ—Ä—ã –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label">–®–∏—Ä–∏–Ω–∞ (px):</label>
                                            <input type="number" name="width" class="form-control border-radius-lg" value="800" min="400" max="2000">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">–í—ã—Å–æ—Ç–∞ (px):</label>
                                            <input type="number" name="height" class="form-control border-radius-lg" value="600" min="300" max="2000">
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞:</label>
                                        <input type="text" name="title" class="form-control border-radius-lg" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫...">
                                    </div>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —Ñ–æ—Ä–º—ã -->
                                <div class="mt-auto pt-2">
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary border-radius-lg" id="createGraphBtn">
                                            <i class="fas fa-chart-line me-2"></i>–°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary border-radius-lg" id="resetFormBtn">
                                            <i class="fas fa-redo me-2"></i>–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö - –ó–ê–ù–ò–ú–ê–ï–¢ –í–°–Å –û–°–¢–ê–í–®–ï–ï–°–Ø –ú–ï–°–¢–û -->
                    <div class="card border-radius-lg shadow-sm flex-grow-1">
                        <div class="card-header bg-gradient-info text-white border-radius-lg-top">
                            <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
                        </div>
                        <div class="card-body p-2 d-flex flex-column h-100">
                            <div id="dataStats" class="flex-grow-1 w-100 h-100">
                                {% if stats %}
                                    <div class="table-responsive h-100 w-100">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                                                <tr>
                                                    <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                                                    <th>–°—Ä–µ–¥–Ω–µ–µ</th>
                                                    <th>Std</th>
                                                    <th>Min</th>
                                                    <th>Max</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for param, values in stats.items() %}
                                                <tr>
                                                    <td><small class="fw-bold text-dark">{{ param }}</small></td>
                                                    <td><small>{{ "%.2f"|format(values.mean) if values.mean is not none else 'N/A' }}</small></td>
                                                    <td><small>{{ "%.2f"|format(values.std) if values.std is not none else 'N/A' }}</small></td>
                                                    <td><small>{{ "%.2f"|format(values.min) if values.min is not none else 'N/A' }}</small></td>
                                                    <td><small>{{ "%.2f"|format(values.max) if values.max is not none else 'N/A' }}</small></td>
                                                    <td><small class="badge bg-primary">{{ values.count }}</small></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center h-100 w-100">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                            <p class="mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ì—Ä–∞—Ñ–∏–∫ -->
                <div class="col-lg-8 h-100" style="min-height: 500px;">
                    <div class="card border-radius-lg shadow-sm h-100">
                        <div class="card-header bg-gradient-primary text-white border-radius-lg-top d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç</h5>
                            <div class="btn-group" id="graphControls" style="display: none;">
                                <button class="btn btn-sm btn-light" id="downloadGraphBtn">
                                    <i class="fas fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å
                                </button>
                                <button class="btn btn-sm btn-light" id="fullscreenBtn">
                                    <i class="fas fa-expand me-1"></i>–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-3 d-flex flex-column h-100" style="min-height: 500px;">
                            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                            <div id="graphMessages" class="flex-shrink-0"></div>
                            
                            <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
                            <div id="graphArea" class="flex-grow-1 position-relative" 
                                style="min-height: 450px;">
                                
                                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
                                <div id="defaultState" class="w-100 h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                                    <h5 class="text-muted">–ì—Ä–∞—Ñ–∏–∫ –Ω–µ —Å–æ–∑–¥–∞–Ω</h5>
                                    <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫"</p>
                                </div>
                                
                                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
                                <div id="dynamicGraphContainer" class="w-100 h-100" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">–ü–æ–º–æ—â—å –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –≥—Ä–∞—Ñ–∏–∫–æ–≤</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–¢–∏–ø—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Matplotlib</strong> - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏</li>
                            <li><strong>Plotly</strong> - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π</li>
                            <li><strong>Seaborn</strong> - —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏</li>
                        </ul>
                        
                        <h6>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:</h6>
                        <ul class="list-unstyled">
                            <li>‚Ä¢ –ó–æ–ª—å–Ω–æ—Å—Ç—å vs –¢–µ–ø–ª–æ—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è</li>
                            <li>‚Ä¢ –ü–ª–æ—Ç–Ω–æ—Å—Ç—å vs –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ñ–æ—Ä–º—ã</li>
                            <li>‚Ä¢ –í—Ä–µ–º—è –≥–æ—Ä–µ–Ω–∏—è vs –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>–°–æ–≤–µ—Ç—ã:</h6>
                        <ul>
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö</li>
                            <li>–î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Plotly –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
                            <li>–ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li>
                            <li>3D –≥—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–±—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä Z</li>
                        </ul>
                        
                        <h6>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</h6>
                        <ul class="list-unstyled">
                            <li><kbd>Enter</kbd> - —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</li>
                            <li><kbd>R</kbd> - —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                            <li><kbd>F</kbd> - –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>

/* –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –°–¢–ò–õ–ò –¢–û–õ–¨–ö–û –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –°–û–ó–î–ê–ù–ò–Ø –ì–†–ê–§–ò–ö–û–í */
#create-graph-page .container-fluid {
    height: calc(100vh - 80px) !important;
    padding: 0 !important;
    margin: 0 !important;
}

#create-graph-page .container-fluid .row {
    height: 100% !important;
    margin: 0 !important;
}

#create-graph-page .container-fluid .row > .col-12 {
    height: 100% !important;
    padding: 0 !important;
}

/* –ì–õ–ê–í–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
#create-graph-page .py-4 {
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    height: 100% !important;
}

/* –ö–ê–†–¢–û–ß–ö–ò - –ó–ê–ù–ò–ú–ê–Æ–¢ –í–°–Æ –í–´–°–û–¢–£ */
#create-graph-page .card {
    height: 100% !important;
    margin-bottom: 0 !important;
    display: flex !important;
    flex-direction: column !important;
}

#create-graph-page .card-body {
    flex: 1 !important;
    overflow: hidden !important;
    padding: 0.5rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê - –§–û–†–ú–ê –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
#create-graph-page .col-lg-4 {
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    padding-right: 5px !important;
}

#create-graph-page .col-lg-4 > .card:first-child {
    flex: 0 0 65% !important;
    min-height: 0 !important;
}

#create-graph-page .col-lg-4 > .card:last-child {
    flex: 1 !important;
    min-height: 0 !important;
}

/* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê - –ì–†–ê–§–ò–ö (–ö–û–ú–ü–ê–ö–¢–ù–ê–Ø) */
#create-graph-page .col-lg-8 {
    height: 100% !important;
    padding-left: 5px !important;
}

#create-graph-page .col-lg-8 > .card {
    height: 100% !important;
}

/* –ö–û–ú–ü–ê–ö–¢–ù–´–ô HEADER –î–õ–Ø –ö–ê–†–¢–û–ß–ö–ò –ì–†–ê–§–ò–ö–ê */
#create-graph-page .col-lg-8 .card-header {
    padding: 0.4rem 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    min-height: auto !important;
}

#create-graph-page .col-lg-8 .card-header h5 {
    font-size: 0.9rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    margin: 0 !important;
}

/* –ó–ê–ì–û–õ–û–í–û–ß–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê */
#create-graph-page .card.mb-4 {
    margin-bottom: 8px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    flex: 0 0 auto !important;
    height: auto !important;
}

/* –§–û–†–ú–ê –ù–ê–°–¢–†–û–ï–ö –ì–†–ê–§–ò–ö–ê */
#create-graph-page #graph-form {
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}

#create-graph-page #graph-form .card-body {
    overflow-y: auto !important;
    flex: 1 !important;
    padding: 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–ê–ù–ù–´–• - –ó–ê–ù–ò–ú–ê–ï–¢ –í–°–Å –û–°–¢–ê–í–®–ï–ï–°–Ø –ú–ï–°–¢–û */
#create-graph-page #dataStats {
    height: 100% !important;
    max-height: none !important;
}

#create-graph-page #dataStats .table-responsive {
    height: 100% !important;
    max-height: none !important;
}

#create-graph-page #dataStats table {
    margin-bottom: 0 !important;
}

#create-graph-page #dataStats tbody {
    max-height: none !important;
}

/* –°–¢–ò–õ–ò –î–õ–Ø –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–û–ì–û –†–ï–ñ–ò–úA */
:fullscreen .js-plotly-plot,
:fullscreen .plotly,
:-webkit-full-screen .js-plotly-plot,
:-webkit-full-screen .plotly,
:-ms-fullscreen .js-plotly-plot,
:-ms-fullscreen .plotly {
    width: 100vw !important;
    height: 100vh !important;
    background: white !important;
    padding: 20px !important;
}

:fullscreen img,
:-webkit-full-screen img,
:-ms-fullscreen img {
    max-width: 95vw !important;
    max-height: 95vh !important;
    object-fit: contain !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ */
:fullscreen #dynamicGraphContainer,
:-webkit-full-screen #dynamicGraphContainer,
:-ms-fullscreen #dynamicGraphContainer {
    background: white !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 20px !important;
}

/* –ö–û–ù–¢–ï–ô–ù–ï–†–´ –ì–†–ê–§–ò–ö–û–í - –ö–û–ú–ü–ê–ö–¢–ù–´–ï –ë–ï–ó –û–¢–°–¢–£–ü–û–í */
#create-graph-page #graphContainer, 
#create-graph-page #plotlyContainer {
    height: 100% !important;
    min-height: 450px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
    margin: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
}

#create-graph-page #graphContainer img {
    max-height: 100% !important;
    max-width: 100% !important;
    object-fit: contain !important;
    padding: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
    margin: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
}

/* PLOTLY –ì–†–ê–§–ò–ö–ò - –ö–û–ú–ü–ê–ö–¢–ù–´–ï */
#create-graph-page #plotlyContainer .js-plotly-plot {
    width: 100% !important;
    height: 100% !important;
    min-height: 450px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    padding: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
    margin: 0 !important; /* –î–û–ë–ê–í–õ–ï–ù–û */
}

/* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô - –ö–û–ú–ü–ê–ö–¢–ù–´–ô */
#create-graph-page #graphMessages {
    flex: 0 0 auto !important;
    padding: 0.25rem 0 !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    margin-bottom: 0.25rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    min-height: auto !important;
}

/* –¢–ê–ë–õ–ò–¶–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
#create-graph-page .table-responsive {
    max-height: 100% !important;
}

#create-graph-page .table {
    margin-bottom: 0 !important;
    font-size: 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .table th, 
#create-graph-page .table td {
    padding: 0.25rem 0.15rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    white-space: nowrap !important;
}

/* –°–ö–†–û–õ–õ–ë–ê–†–´ */
#create-graph-page .card-body::-webkit-scrollbar {
    width: 4px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
@media (max-width: 992px) {
    #create-graph-page .container-fluid {
        height: auto !important;
        min-height: calc(100vh - 80px) !important;
    }
    
    #create-graph-page .col-lg-4, 
    #create-graph-page .col-lg-8 {
        height: auto !important;
        min-height: 45vh !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    }
    
    #create-graph-page .col-lg-4 > .card:first-child {
        flex: 0 0 auto !important;
        height: auto !important;
        min-height: 350px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    }
    
    /* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –ì–†–ê–§–ò–ö–ò –ù–ê –ú–û–ë–ò–õ–¨–ù–´–• */
    #create-graph-page #graphContainer, 
    #create-graph-page #plotlyContainer {
        min-height: 350px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    }
}

#defaultState, #dynamicGraphContainer {
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#defaultState {
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* –£–õ–£–ß–®–ï–ù–ò–Ø –î–õ–Ø –§–û–†–ú–´ */
#create-graph-page .form-select, 
#create-graph-page .form-control {
    font-size: 0.8rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .btn {
    font-size: 0.85rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –ó–ê–ì–û–õ–û–í–ö–ò –ö–ê–†–¢–û–ß–ï–ö */
#create-graph-page .card-header {
    padding: 0.5rem 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    flex: 0 0 auto !important;
}

#create-graph-page .card-header h5 {
    font-size: 0.9rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    margin: 0 !important;
}

/* –£–ë–ò–†–ê–ï–ú –õ–ò–®–ù–ò–ï –û–¢–°–¢–£–ü–´ */
#create-graph-page .mb-4, 
#create-graph-page .mb-3, 
#create-graph-page .mb-2 {
    margin-bottom: 0.4rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .row {
    --bs-gutter-x: 0.4rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    --bs-gutter-y: 0.4rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –£–õ–£–ß–®–ï–ù–ò–Ø –î–õ–Ø –¢–ê–ë–õ–ò–¶–´ –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
#create-graph-page #dataStats .table thead {
    position: sticky !important;
    top: 0 !important;
    background: #f8f9fa !important;
    z-index: 10 !important;
}

#create-graph-page #dataStats .table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

/* –£–õ–£–ß–®–ï–ù–ò–Ø –î–õ–Ø –ö–ù–û–ü–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
#create-graph-page #graphControls {
    flex: 0 0 auto !important;
}

#create-graph-page #graphControls .btn {
    padding: 0.25rem 0.5rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    font-size: 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –û–ë–ï–°–ü–ï–ß–ò–í–ê–ï–ú –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê */
#create-graph-page .d-flex {
    display: flex !important;
}

#create-graph-page .flex-column {
    flex-direction: column !important;
}

#create-graph-page .flex-grow-1 {
    flex-grow: 1 !important;
}

#create-graph-page .flex-shrink-0 {
    flex-shrink: 0 !important;
}

#create-graph-page .h-100 {
    height: 100% !important;
}

#create-graph-page .w-100 {
    width: 100% !important;
}

/* –£–õ–£–ß–®–ï–ù–ò–Ø –î–õ–Ø SCROLLABLE –ö–û–ù–¢–ï–ô–ù–ï–†–û–í */
#create-graph-page .overflow-auto {
    overflow: auto !important;
}

#create-graph-page .overflow-hidden {
    overflow: hidden !important;
}

/* –§–ò–ö–° –î–õ–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –ì–†–ê–§–ò–ö–û–í */
#create-graph-page .img-fluid {
    max-height: 100% !important;
    width: auto !important;
}

/* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –†–ê–î–ò–£–°–´ */
.border-radius-lg {
    border-radius: 8px !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

.border-radius-lg-top {
    border-radius: 8px 8px 0 0 !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –û–ë–©–ò–ï –°–¢–ò–õ–ò –ö–û–¢–û–†–´–ï –ù–ï –õ–û–ú–ê–Æ–¢ NAVBAR */
.card {
    border: none;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06); /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

.btn {
    border-radius: 6px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.form-select {
    border-radius: 6px; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25); /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

/* –£–ë–ò–†–ê–ï–ú –ö–û–ù–§–õ–ò–ö–¢–´ –° –¢–ï–ú–û–ô */
.modebar {
    z-index: 1000 !important;
}

/* –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ü–ê–ö–¢–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ì–†–ê–§–ò–ö–û–í */
#create-graph-page .col-lg-8 .card-body {
    padding: 0.25rem !important; /* –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –û–¢–°–¢–£–ü */
}

#create-graph-page #graphContainer .text-muted,
#create-graph-page #plotlyContainer .text-muted {
    padding: 0.5rem !important; /* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –û–¢–°–¢–£–ü–´ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô */
}

/* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –§–û–†–ú–´ */
#create-graph-page .form-label {
    margin-bottom: 0.3rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    font-size: 0.8rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#create-graph-page .form-check {
    margin-bottom: 0.3rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    min-height: auto !important;
}

/* –ö–û–ú–ü–ê–ö–¢–ù–´–ï –ö–ù–û–ü–ö–ò –í –§–û–†–ú–ï */
#create-graph-page #graph-form .btn {
    padding: 0.4rem 0.75rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
    margin-top: 0.5rem !important; /* –£–ú–ï–ù–¨–®–ï–ù–û */
}

#defaultState {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s ease !important;
    z-index: 1 !important;
}

/* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø PLOTLY –ö–û–ù–¢–ï–ô–ù–ï–†–ê */
#dynamicGraphContainer {
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    min-height: 500px !important;
    overflow: visible !important; /* –í–ê–ñ–ù–û: —Ä–∞–∑—Ä–µ—à–∞–µ–º overflow */
    z-index: 2 !important;
    padding: 10px !important; /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–æ–≤ */
}

/* –°–¢–ò–õ–ò –î–õ–Ø PLOTLY –ì–†–ê–§–ò–ö–û–í - –£–ë–ò–†–ê–ï–ú –í–°–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø */
#dynamicGraphContainer .js-plotly-plot,
#dynamicGraphContainer .plotly,
#dynamicGraphContainer .plot-container {
    width: 100% !important;
    height: 100% !important;
    min-height: 450px !important;
    overflow: visible !important; /* –í–ê–ñ–ù–û */
}

/* –û–°–ù–û–í–ù–û–ô SVG PLOTLY */
#dynamicGraphContainer .main-svg {
    width: 100% !important;
    height: 100% !important;
    overflow: visible !important;
}

/* –ö–û–ù–¢–ï–ô–ù–ï–† SVG */
#dynamicGraphContainer .svg-container {
    width: 100% !important;
    height: 100% !important;
    min-height: 450px !important;
    overflow: visible !important;
}

/* –£–í–ï–õ–ò–ß–ò–í–ê–ï–ú –û–ë–õ–ê–°–¢–¨ –ì–†–ê–§–ò–ö–ê */
#dynamicGraphContainer .plotly .graph {
    width: 100% !important;
    height: 100% !important;
}

/* –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –õ–ï–ì–ï–ù–î–´ –ò –û–°–ï–ô */
#dynamicGraphContainer .plotly .legend {
    max-width: 100% !important;
    overflow: visible !important;
}

#dynamicGraphContainer .plotly .xaxislayer,
#dynamicGraphContainer .plotly .yaxislayer {
    overflow: visible !important;
}

/* –£–ë–ï–†–ê–ï–ú –õ–Æ–ë–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –í CARD-BODY */
.card-body {
    min-height: 500px !important;
    overflow: visible !important; /* –í–ê–ñ–ù–û */
    padding: 10px !important;
}

/* GRAPHAREA –î–û–õ–ñ–ù–ê –ë–´–¢–¨ –° OVERFLOW VISIBLE */
#graphArea {
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    min-height: 450px !important;
    overflow: visible !important; /* –í–ê–ñ–ù–û */
    flex: 1 !important;
}

/* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê */
.col-lg-8 {
    height: 100% !important;
    min-height: 500px !important;
    overflow: visible !important;
}

/* –£–í–ï–õ–ò–ß–ò–ú –†–ê–ó–ú–ï–†–´ –î–õ–Ø –õ–£–ß–®–ï–ì–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø */
#create-graph-page .col-lg-8 .card {
    min-height: 550px !important;
}

#create-graph-page .col-lg-8 .card-body {
    min-height: 500px !important;
}

</style>

<script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>

<script>


function testPlotlyManually() {
    // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
    const testData = [{
        x: [1, 2, 3, 4, 5],
        y: [1, 2, 3, 4, 5],
        type: 'scatter'
    }];
    
    const testLayout = {
        title: '–¢–µ—Å—Ç–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ Plotly',
        width: 800,
        height: 600
    };
    
    const plotlyContainer = document.getElementById('plotlyContainer');
    plotlyContainer.innerHTML = '<div id="manual-test-plot" style="width: 100%; height: 500px;"></div>';
    plotlyContainer.style.display = 'block';
    
    if (typeof Plotly !== 'undefined') {
        Plotly.newPlot('manual-test-plot', testData, testLayout);
        console.log('‚úÖ Manual Plotly test successful');
    } else {
        console.error('‚ùå Plotly not available for manual test');
        plotlyContainer.innerHTML = '<div class="alert alert-danger">Plotly.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>';
    }
}
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentGraph = null;
let currentGraphType = 'matplotlib';

// –°–ø–∏—Å–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
const GRAPHS_BY_TYPE = {
    matplotlib: [
        {value: 'scatter', label: '–¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'line', label: '–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫'},
        {value: 'bar', label: '–°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'histogram', label: '–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞'},
        {value: 'box', label: 'Box Plot'},
        {value: 'pie', label: '–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'heatmap', label: '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞'},
        {value: '3d_scatter', label: '3D Scatter'}
    ],
    plotly: [
        {value: 'scatter', label: '–¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'line', label: '–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫'},
        {value: 'bar', label: '–°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'histogram', label: '–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞'},
        {value: 'box', label: 'Box Plot'},
        {value: 'violin', label: 'Violin Plot'},
        {value: 'pie', label: '–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'heatmap', label: '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞'},
        {value: 'radar', label: '–†–∞–¥–∞—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'sunburst', label: 'Sunburst'},
        {value: 'treemap', label: 'Treemap'},
        {value: '3d_scatter', label: '3D Scatter'},
        {value: 'animated_scatter', label: '–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫'}
    ],
    seaborn: [
        {value: 'scatter', label: '–¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'line', label: '–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫'},
        {value: 'bar', label: '–°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞'},
        {value: 'histogram', label: '–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞'},
        {value: 'box', label: 'Box Plot'},
        {value: 'violin', label: 'Violin Plot'},
        {value: 'heatmap', label: '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞'}
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== –£–ü–†–û–©–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===');
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Plotly
        setTimeout(() => {
            if (typeof Plotly !== 'undefined') {
                console.log('‚úÖ Plotly.js –¥–æ—Å—Ç—É–ø–µ–Ω');
            } else {
                console.warn('‚ö†Ô∏è Plotly.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
        }, 1000);
        
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const defaultState = document.getElementById('defaultState');
        const dynamicContainer = document.getElementById('dynamicGraphContainer');
        
        if (defaultState) defaultState.style.display = 'flex';
        if (dynamicContainer) dynamicContainer.style.display = 'none';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (!checkFullscreenSupport()) {
            console.warn('‚ö†Ô∏è –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.disabled = true;
                fullscreenBtn.title = '–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º';
            }
        }

        initializeForm();
        setupEventListeners();
        updateFormOptions();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    }
    
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
});

function initializeForm() {
    console.log('=== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã ===');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    const xParam = document.getElementById('xParam');
    const yParam = document.getElementById('yParam');
    const graphType = document.getElementById('graphType');
    const vizType = document.getElementById('vizType');
    
    if (xParam) xParam.value = 'ad';
    if (yParam) yParam.value = 'q';
    if (graphType) graphType.value = 'scatter';
    if (vizType) vizType.value = 'matplotlib';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    updateGraphsList('matplotlib');
    
    console.log('‚úÖ –§–æ—Ä–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
}

function updateGraphsList(vizType) {
    const graphTypeSelect = document.getElementById('graphType');
    const graphs = GRAPHS_BY_TYPE[vizType] || GRAPHS_BY_TYPE.matplotlib;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const currentValue = graphTypeSelect.value;
    
    // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫
    graphTypeSelect.innerHTML = '';
    graphs.forEach(graph => {
        const option = document.createElement('option');
        option.value = graph.value;
        option.textContent = graph.label;
        graphTypeSelect.appendChild(option);
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
    if (graphs.some(g => g.value === currentValue)) {
        graphTypeSelect.value = currentValue;
    } else {
        graphTypeSelect.value = graphs[0].value;
    }
}

function setupEventListeners() {
    console.log('=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π ===');
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞
    const form = document.getElementById('graph-form');
    if (form) {
        form.addEventListener('submit', handleGraphCreation);
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω');
    } else {
        console.error('‚ùå –§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
    const helpBtn = document.getElementById('helpBtn');
    const resetBtn = document.getElementById('resetFormBtn');
    const downloadBtn = document.getElementById('downloadGraphBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    if (helpBtn) {
        helpBtn.addEventListener('click', () => {
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                new bootstrap.Modal(helpModal).show();
            }
        });
    }

    if (resetBtn) resetBtn.addEventListener('click', resetForm);
    if (downloadBtn) downloadBtn.addEventListener('click', downloadGraph);
    if (fullscreenBtn) fullscreenBtn.addEventListener('click', toggleFullscreen);

    // –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ
    const vizType = document.getElementById('vizType');
    const graphType = document.getElementById('graphType');
    
    if (vizType) {
        vizType.addEventListener('change', function() {
            updateGraphsList(this.value);
            updateFormOptions();
        });
    }
    
    if (graphType) {
        graphType.addEventListener('change', updateFormOptions);
    }

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', handleKeyboardShortcuts);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('msfullscreenchange', handleFullscreenChange);
    
    console.log('=== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ===');
}

function handleFullscreenChange() {
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    
    if (!document.fullscreenElement && 
        !document.webkitFullscreenElement && 
        !document.msFullscreenElement) {
        // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        console.log('üîö –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä Plotly –≥—Ä–∞—Ñ–∏–∫–æ–≤
        setTimeout(() => {
            const plotlyGraphs = document.querySelectorAll('.js-plotly-plot');
            plotlyGraphs.forEach(graph => {
                if (typeof Plotly !== 'undefined') {
                    Plotly.Plots.resize(graph);
                }
            });
            console.log('‚úÖ –†–∞–∑–º–µ—Ä Plotly –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞');
        }, 100);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (fullscreenBtn) {
            fullscreenBtn.innerHTML = '<i class="fas fa-expand me-1"></i>–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω';
        }
    } else {
        // –í—Ö–æ–¥ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        if (fullscreenBtn) {
            fullscreenBtn.innerHTML = '<i class="fas fa-compress me-1"></i>–í—ã–π—Ç–∏';
        }
    }
}

function updateFormOptions() {
    const vizType = document.getElementById('vizType').value;
    const graphType = document.getElementById('graphType').value;
    const plotlyOptions = document.getElementById('plotlyOptions');
    const yParamGroup = document.getElementById('yParam').closest('.row');
    const zParamGroup = document.getElementById('zParam').closest('.row');

    // –û–ø—Ü–∏–∏ –¥–ª—è Plotly
    if (vizType === 'plotly') {
        plotlyOptions.style.display = 'block';
    } else {
        plotlyOptions.style.display = 'none';
    }

    // –î–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º —Å–∫—Ä—ã–≤–∞–µ–º Y –ø–∞—Ä–∞–º–µ—Ç—Ä
    if (graphType === 'pie' || graphType === 'sunburst' || graphType === 'treemap') {
        yParamGroup.style.display = 'none';
    } else {
        yParamGroup.style.display = 'flex';
    }

    // –û–ø—Ü–∏–∏ –¥–ª—è 3D –≥—Ä–∞—Ñ–∏–∫–æ–≤
    if (graphType === '3d_scatter') {
        zParamGroup.style.display = 'flex';
    } else {
        zParamGroup.style.display = 'none';
    }
}

async function handleGraphCreation(e) {
    // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    e.preventDefault();
    e.stopPropagation();
    
    console.log('üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞...');
    
    const form = document.getElementById('graph-form');
    const submitBtn = document.getElementById('createGraphBtn');
    
    if (!form) {
        console.error('‚ùå –§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    const formData = new FormData(form);
    
    console.log('üìä Form data:', Object.fromEntries(formData));
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –î–û –∑–∞–ø—Ä–æ—Å–∞:', {
        graphArea: !!document.getElementById('graphArea'),
        defaultState: !!document.getElementById('defaultState'),
        dynamicContainer: !!document.getElementById('dynamicGraphContainer'),
        form: !!form
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–°–æ–∑–¥–∞–Ω–∏–µ...';
    
    clearMessages();
    
    try {
        console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
        const response = await fetch('/create_graph', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω:', data);
        
        if (data.success) {
            console.log('üéØ –í—ã–∑–æ–≤ displayGraph...');
            safeDisplayGraph(data.graph, data.graph_type);
            showMessage(data.message, 'success');
            updateStatistics(data.stats);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const graphControls = document.getElementById('graphControls');
            if (graphControls) {
                graphControls.style.display = 'flex';
            }
        } else {
            showMessage(data.message, 'danger');
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + error.message, 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>–°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫';
    }
    
    return false;
}

function ensureContainersExist() {
    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...');
    
    let graphContainer = document.getElementById('graphContainer');
    let plotlyContainer = document.getElementById('plotlyContainer');
    
    console.log('üì¶ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', {
        graphContainer: !!graphContainer,
        plotlyContainer: !!plotlyContainer
    });
    
    // –ï—Å–ª–∏ plotlyContainer –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –≤ –ü–†–ê–í–ò–õ–¨–ù–û–ú –º–µ—Å—Ç–µ
    if (!plotlyContainer) {
        console.warn('‚ö†Ô∏è plotlyContainer –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ...');
        
        // –ù–∞—Ö–æ–¥–∏–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - —Ç–æ—Ç, –≥–¥–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫
        const graphArea = document.querySelector('.col-lg-8 .card-body');
        if (graphArea) {
            plotlyContainer = document.createElement('div');
            plotlyContainer.id = 'plotlyContainer';
            plotlyContainer.style.display = 'none';
            plotlyContainer.style.height = '100%';
            plotlyContainer.style.width = '100%';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ü–†–ê–í–ò–õ–¨–ù–û–ï –º–µ—Å—Ç–æ - –≤ –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞
            graphArea.appendChild(plotlyContainer);
            console.log('‚úÖ plotlyContainer —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞');
        } else {
            console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è plotlyContainer');
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
            const rightColumn = document.querySelector('.col-lg-8');
            if (rightColumn) {
                const cardBody = rightColumn.querySelector('.card-body');
                if (cardBody) {
                    plotlyContainer = document.createElement('div');
                    plotlyContainer.id = 'plotlyContainer';
                    plotlyContainer.style.display = 'none';
                    plotlyContainer.style.height = '100%';
                    plotlyContainer.style.width = '100%';
                    cardBody.appendChild(plotlyContainer);
                    console.log('‚úÖ plotlyContainer —Å–æ–∑–¥–∞–Ω –≤ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ');
                }
            }
        }
    }
    
    return {
        graphContainer: graphContainer || document.getElementById('graphContainer'),
        plotlyContainer: plotlyContainer || document.getElementById('plotlyContainer')
    };
}

function displayGraph(graphData, graphType) {
    console.log('üé® displayGraph –≤—ã–∑–≤–∞–Ω–∞ —Å:', { graphType, hasData: !!graphData });
    
    const defaultState = document.getElementById('defaultState');
    const dynamicContainer = document.getElementById('dynamicGraphContainer');
    const graphArea = document.getElementById('graphArea');
    
    if (!defaultState || !dynamicContainer || !graphArea) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
        return;
    }
    
    // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    defaultState.style.display = 'none';
    defaultState.style.visibility = 'hidden';
    defaultState.style.opacity = '0';
    defaultState.style.position = 'absolute';
    defaultState.style.zIndex = '-1';
    
    // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    dynamicContainer.style.display = 'block';
    dynamicContainer.style.visibility = 'visible';
    dynamicContainer.style.opacity = '1';
    dynamicContainer.style.position = 'relative';
    dynamicContainer.style.zIndex = '1';
    dynamicContainer.innerHTML = '';
    
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ graphArea –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
    graphArea.style.overflow = 'visible';
    graphArea.style.position = 'relative';
    
    currentGraph = graphData;
    currentGraphType = graphType;
    
    if (!graphData) {
        showDefaultState();
        return;
    }
    
    try {
        if (graphType === 'plotly') {
            console.log('üìà –°–æ–∑–¥–∞–µ–º Plotly –≥—Ä–∞—Ñ–∏–∫');
            createPlotlyGraph(graphData, dynamicContainer);
        } else {
            console.log('üìä –°–æ–∑–¥–∞–µ–º matplotlib –≥—Ä–∞—Ñ–∏–∫');
            dynamicContainer.innerHTML = `
                <div class="h-100 d-flex align-items-center justify-content-center">
                    <img src="data:image/png;base64,${graphData}" 
                         class="img-fluid rounded shadow-sm" 
                         alt="–ì—Ä–∞—Ñ–∏–∫" 
                         style="max-height: 100%; max-width: 100%; object-fit: contain;">
                </div>
            `;
        }
        
        console.log('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            const plotlyContainer = dynamicContainer.querySelector('.plotly, .js-plotly-plot, [id*="plot"]');
            if (plotlyContainer) {
                console.log('‚úÖ Plotly –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏');
            } else {
                console.warn('‚ö†Ô∏è Plotly –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏');
            }
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        showErrorState(dynamicContainer, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + error.message);
    }
}

// –ì–õ–ê–í–ù–´–ï –§–£–ù–ö–¶–ò–ò PLOTLY
function createPlotlyGraph(graphData, container) {
    console.log('üìà –°–æ–∑–¥–∞–µ–º Plotly –≥—Ä–∞—Ñ–∏–∫');
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π div –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = graphData;
    
    // –ò—â–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π Plotly div
    const plotlyDiv = tempDiv.querySelector('.js-plotly-plot, .plotly, [id*="plot"]');
    
    if (plotlyDiv) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω Plotly div');
        
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º Plotly div
        const clonedPlotlyDiv = plotlyDiv.cloneNode(true);
        
        // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
        for (let attr of plotlyDiv.attributes) {
            clonedPlotlyDiv.setAttribute(attr.name, attr.value);
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        clonedPlotlyDiv.style.width = '100%';
        clonedPlotlyDiv.style.height = '100%';
        clonedPlotlyDiv.style.minHeight = '450px';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.appendChild(clonedPlotlyDiv);
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã Plotly
        executePlotlyScriptsSimple(tempDiv, clonedPlotlyDiv.id);
        
    } else {
        console.log('‚ùå Plotly div –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π HTML');
        container.innerHTML = graphData;
        executeAllPlotlyScripts(container);
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
    forcePlotlyResize();
}

function executePlotlyScriptsSimple(container, plotlyId) {
    const scripts = container.querySelectorAll('script');
    let plotlyScript = null;
    
    // –ò—â–µ–º —Å–∫—Ä–∏–ø—Ç —Å Plotly.newPlot
    scripts.forEach(script => {
        if (script.textContent && script.textContent.includes('Plotly.newPlot')) {
            plotlyScript = script.textContent;
        }
    });
    
    if (plotlyScript && typeof Plotly !== 'undefined') {
        console.log('üîß –í—ã–ø–æ–ª–Ω—è–µ–º Plotly —Å–∫—Ä–∏–ø—Ç');
        
        try {
            // –ó–∞–º–µ–Ω—è–µ–º ID –≤ —Å–∫—Ä–∏–ø—Ç–µ –Ω–∞ –Ω–∞—à ID
            const originalIdMatch = plotlyScript.match(/Plotly\.newPlot\(["']([^"']+)["']/);
            if (originalIdMatch) {
                const originalId = originalIdMatch[1];
                plotlyScript = plotlyScript.replace(new RegExp(originalId, 'g'), plotlyId);
            }
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
            eval(plotlyScript);
            console.log('‚úÖ Plotly —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
            setTimeout(() => Plotly.Plots.resize(document.getElementById(plotlyId)), 100);
            setTimeout(() => Plotly.Plots.resize(document.getElementById(plotlyId)), 500);
            setTimeout(() => Plotly.Plots.resize(document.getElementById(plotlyId)), 1000);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Plotly —Å–∫—Ä–∏–ø—Ç–∞:', error);
        }
    }
}

function executeAllPlotlyScripts(container) {
    const scripts = container.querySelectorAll('script');
    
    scripts.forEach((script, index) => {
        if (!script.src && script.textContent && script.textContent.includes('Plotly')) {
            try {
                eval(script.textContent);
                console.log(`‚úÖ –°–∫—Ä–∏–ø—Ç ${index + 1} –≤—ã–ø–æ–ª–Ω–µ–Ω`);
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ ${index + 1}:`, error);
            }
        }
    });
    
    setTimeout(() => {
        if (typeof Plotly !== 'undefined') {
            const plotlyGraphs = container.querySelectorAll('.js-plotly-plot');
            plotlyGraphs.forEach(graph => Plotly.Plots.resize(graph));
        }
    }, 200);
}

function forcePlotlyResize() {
    console.log('üìè –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ layout Plotly');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
    setTimeout(() => {
        const plotlyGraphs = document.querySelectorAll('#dynamicGraphContainer .js-plotly-plot, #dynamicGraphContainer .plotly');
        plotlyGraphs.forEach(graph => {
            if (typeof Plotly !== 'undefined') {
                Plotly.Plots.resize(graph);
            }
        });
    }, 100);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º layout
    setTimeout(adjustPlotlyLayout, 200);
    setTimeout(adjustPlotlyLayout, 500);
    setTimeout(adjustPlotlyLayout, 1000);
}

function adjustPlotlyLayout() {
    const plotlyGraphs = document.querySelectorAll('#dynamicGraphContainer .js-plotly-plot');
    
    plotlyGraphs.forEach((graph, index) => {
        if (typeof Plotly !== 'undefined') {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π layout
            Plotly.relayout(graph, {
                'autosize': true,
                'margin': {
                    'l': 80,   // –ª–µ–≤—ã–π –æ—Ç—Å—Ç—É–ø
                    'r': 80,   // –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø  
                    't': 50,   // –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø
                    'b': 80    // –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø
                },
                'width': graph.clientWidth,
                'height': graph.clientHeight
            }).then(() => {
                console.log(`‚úÖ Layout –≥—Ä–∞—Ñ–∏–∫–∞ ${index + 1} –Ω–∞—Å—Ç—Ä–æ–µ–Ω`);
            });
        }
    });
}

function extractPlotlyDataAdvanced(container) {
    const scripts = container.querySelectorAll('script');
    
    for (let script of scripts) {
        const scriptContent = script.textContent || script.innerHTML;
        
        if (scriptContent.includes('Plotly.newPlot')) {
            console.log('üîç –ù–∞–π–¥–µ–Ω Plotly.newPlot —Å–∫—Ä–∏–ø—Ç');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            const args = extractPlotlyArguments(scriptContent);
            if (args) {
                return args;
            }
        }
        
        // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        if (scriptContent.includes('data = ') || scriptContent.includes('var data')) {
            console.log('üîç –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö');
            const data = extractJavaScriptVariable(scriptContent, 'data');
            const layout = extractJavaScriptVariable(scriptContent, 'layout') || {};
            const config = extractJavaScriptVariable(scriptContent, 'config') || {};
            
            if (data) {
                return { data, layout, config };
            }
        }
    }
    
    return null;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
function checkFullscreenSupport() {
    const doc = document.documentElement;
    const support = !!(doc.requestFullscreen || 
                      doc.webkitRequestFullscreen || 
                      doc.msRequestFullscreen);
    
    console.log('üîç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', support);
    return support;
}


function extractPlotlyArguments(scriptContent) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ - –∏—â–µ–º –≤—ã–∑–æ–≤ Plotly.newPlot –∏ –ø—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–≥–æ
    const plotlyCallMatch = scriptContent.match(/Plotly\.newPlot\(([^)]+)\)/);
    if (!plotlyCallMatch) return null;
    
    const fullCall = plotlyCallMatch[0];
    console.log('üìû –ù–∞–π–¥–µ–Ω –≤—ã–∑–æ–≤ Plotly:', fullCall.substring(0, 200) + '...');
    
    try {
        // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        const data = [];
        const layout = {};
        const config = {};
        
        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        window.tempPlotlyData = data;
        window.tempPlotlyLayout = layout;
        window.tempPlotlyConfig = config;
        
        // –ó–∞–º–µ–Ω—è–µ–º –≤—ã–∑–æ–≤ Plotly –Ω–∞ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –Ω–∞—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
        const modifiedScript = scriptContent
            .replace(/Plotly\.newPlot\([^,]+,\s*([^,]+),\s*([^,]+),\s*([^)]+)\)/,
                'window.tempPlotlyData = $1; window.tempPlotlyLayout = $2; window.tempPlotlyConfig = $3;')
            .replace(/Plotly\.newPlot\([^,]+,\s*([^,]+),\s*([^)]+)\)/,
                'window.tempPlotlyData = $1; window.tempPlotlyLayout = $2;');
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
        eval(modifiedScript);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const result = {
            data: window.tempPlotlyData,
            layout: window.tempPlotlyLayout,
            config: window.tempPlotlyConfig
        };
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        delete window.tempPlotlyData;
        delete window.tempPlotlyLayout;
        delete window.tempPlotlyConfig;
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã:', {
            data_length: result.data ? result.data.length : 0,
            layout_keys: result.layout ? Object.keys(result.layout) : []
        });
        
        return result;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤:', error);
        return null;
    }
}

function extractJavaScriptVariable(scriptContent, varName) {
    // –ò—â–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    const patterns = [
        new RegExp(`(?:var|let|const)\\s+${varName}\\s*=\\s*({[^;]+});?`),
        new RegExp(`(?:var|let|const)\\s+${varName}\\s*=\\s*(\\[[^;]+\\]);?`),
        new RegExp(`${varName}\\s*=\\s*({[^;]+});?`),
        new RegExp(`${varName}\\s*=\\s*(\\[[^;]+\\]);?`)
    ];
    
    for (let pattern of patterns) {
        const match = scriptContent.match(pattern);
        if (match) {
            try {
                // –ß–∏—Å—Ç–∏–º —Å—Ç—Ä–æ–∫—É –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
                let jsonStr = match[1]
                    .replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":') // –ö–ª—é—á–∏ –≤ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                    .replace(/'/g, '"') // –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –Ω–∞ –¥–≤–æ–π–Ω—ã–µ
                    .replace(/,(\s*[}\]])/g, '$1'); // –£–±–∏—Ä–∞–µ–º –≤–∏—Å—è—â–∏–µ –∑–∞–ø—è—Ç—ã–µ
                
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ${varName}:`, e);
                console.log('üìÑ –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:', match[1].substring(0, 100));
                continue;
            }
        }
    }
    
    return null;
}

function executePlotlyScriptsAdvanced(container, targetId) {
    const scripts = container.querySelectorAll('script');
    let executed = false;
    
    scripts.forEach((script, index) => {
        if (!script.src && script.textContent) {
            try {
                let modifiedScript = script.textContent;
                
                // –ó–∞–º–µ–Ω—è–µ–º ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (modifiedScript.includes("document.getElementById('")) {
                    const idMatch = modifiedScript.match(/document\.getElementById\('([^']+)'\)/);
                    if (idMatch) {
                        modifiedScript = modifiedScript.replace(new RegExp(idMatch[1], 'g'), targetId);
                    }
                }
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç
                eval(modifiedScript);
                executed = true;
                console.log(`‚úÖ –°–∫—Ä–∏–ø—Ç ${index + 1} –≤—ã–ø–æ–ª–Ω–µ–Ω`);
                
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ ${index + 1}:`, error);
            }
        }
    });
    
    if (executed) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
        setTimeout(() => {
            const plotlyDiv = document.getElementById(targetId);
            if (plotlyDiv && typeof Plotly !== 'undefined') {
                Plotly.Plots.resize(plotlyDiv);
                console.log('‚úÖ –†–∞–∑–º–µ—Ä Plotly –≥—Ä–∞—Ñ–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
        }, 300);
    } else {
        console.log('‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç—ã –Ω–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥');
        useDirectHTMLRender(container.innerHTML, targetId);
    }
}

function useDirectHTMLRender(graphData, graphId) {
    console.log('üîÑ –ü—Ä—è–º–æ–π HTML —Ä–µ–Ω–¥–µ—Ä Plotly');
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = graphData;
    
    // –ò—â–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Plotly div
    const originalDiv = tempDiv.querySelector('.js-plotly-plot');
    const targetDiv = document.getElementById(graphId);
    
    if (originalDiv && targetDiv) {
        // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –∞—Ç—Ä–∏–±—É—Ç—ã
        targetDiv.innerHTML = originalDiv.innerHTML;
        targetDiv.className = originalDiv.className;
        
        for (let attr of originalDiv.attributes) {
            targetDiv.setAttribute(attr.name, attr.value);
        }
        
        console.log('‚úÖ HTML –Ω–∞–ø—Ä—è–º—É—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Plotly –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
        if (typeof Plotly !== 'undefined' && targetDiv.classList.contains('js-plotly-plot')) {
            setTimeout(() => {
                try {
                    Plotly.Plots.resize(targetDiv);
                    console.log('‚úÖ Plotly –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –ø—Ä—è–º–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞');
                } catch (e) {
                    console.log('‚ÑπÔ∏è Plotly —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }
            }, 500);
        }
    } else {
        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º HTML
        targetDiv.innerHTML = graphData;
        console.log('‚úÖ –í–µ—Å—å HTML –≤—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞–ø—Ä—è–º—É—é');
    }
}

function extractPlotlyData(scriptContent) {
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    const patterns = [
        /Plotly\.newPlot\([^,]+,([^,]+),([^,]+),([^)]+)\)/,
        /Plotly\.newPlot\([^,]+,([^,]+),([^)]+)\)/,
        /Plotly\.plot\([^,]+,([^,]+),([^,]+),([^)]+)\)/
    ];
    
    for (let pattern of patterns) {
        const match = scriptContent.match(pattern);
        if (match) {
            try {
                const data = JSON.parse(match[1].trim());
                const layout = match[2] ? JSON.parse(match[2].trim()) : {};
                const config = match[3] ? JSON.parse(match[3].trim()) : {};
                
                return { data, layout, config };
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö Plotly:', e);
                continue;
            }
        }
    }
    
    return null;
}

function extractFromScript(scriptContent, variableName) {
    const pattern = new RegExp(`(?:var|let|const)\\s+${variableName}\\s*=\\s*({[^;]+});?`, 'i');
    const match = scriptContent.match(pattern);
    
    if (match) {
        try {
            return JSON.parse(match[1]);
        } catch (e) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ${variableName}:`, e);
        }
    }
    
    return null;
}

function fallbackPlotlyRender(graphData, graphId) {
    console.log('üîÑ Fallback —Ä–µ–Ω–¥–µ—Ä Plotly');
    
    // –ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º HTML –∏ –ø—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = graphData;
    
    // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π div Plotly
    const originalPlotlyDiv = tempContainer.querySelector('.js-plotly-plot');
    
    if (originalPlotlyDiv && originalPlotlyDiv.id) {
        // –ï—Å–ª–∏ —É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ div –µ—Å—Ç—å ID, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        const targetDiv = document.getElementById(graphId);
        if (targetDiv) {
            targetDiv.id = originalPlotlyDiv.id;
            targetDiv.innerHTML = originalPlotlyDiv.innerHTML;
            targetDiv.className = originalPlotlyDiv.className;
            
            // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
            for (let attr of originalPlotlyDiv.attributes) {
                targetDiv.setAttribute(attr.name, attr.value);
            }
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã
            executePlotlyScriptsSimple(tempContainer);
            console.log('‚úÖ Fallback —Ä–µ–Ω–¥–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω');
        }
    } else {
        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ—Å—Ç–æ–π HTML
        document.getElementById(graphId).innerHTML = 
            '<div class="alert alert-warning h-100 d-flex align-items-center justify-content-center">' +
            '<div class="text-center"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i>' +
            '<p>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</p>' +
            '<button class="btn btn-sm btn-outline-primary mt-2" onclick="retryPlotlyRender()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>' +
            '</div></div>';
    }
}

function resizePlotlyGraph() {
    const dynamicContainer = document.getElementById('dynamicGraphContainer');
    if (!dynamicContainer) return;
    
    const plotlyGraphs = dynamicContainer.querySelectorAll('.js-plotly-plot, .plotly');
    
    plotlyGraphs.forEach((graph, index) => {
        if (typeof Plotly !== 'undefined') {
            setTimeout(() => {
                try {
                    Plotly.Plots.resize(graph);
                    console.log(`‚úÖ –†–∞–∑–º–µ—Ä Plotly –≥—Ä–∞—Ñ–∏–∫–∞ ${index + 1} –æ–±–Ω–æ–≤–ª–µ–Ω`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞ ${index + 1}:`, error);
                }
            }, 100 * (index + 1));
        }
    });
}



function createMatplotlibGraph(graphData, container) {
    container.innerHTML = `
        <div class="h-100 d-flex align-items-center justify-content-center">
            <img src="data:image/png;base64,${graphData}" 
                 class="img-fluid rounded shadow-sm" 
                 alt="–ì—Ä–∞—Ñ–∏–∫" 
                 style="max-height: 100%; max-width: 100%; object-fit: contain;">
        </div>
    `;
}

function showErrorState(container, message) {
    container.innerHTML = `
        <div class="alert alert-warning h-100 d-flex align-items-center justify-content-center">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p class="mb-2">${message}</p>
                <button class="btn btn-sm btn-outline-primary mt-1" onclick="retryPlotlyRender()">
                    <i class="fas fa-redo me-1"></i>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        </div>
    `;
}

function retryPlotlyRender() {
    if (currentGraph && currentGraphType === 'plotly') {
        console.log('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Plotly –≥—Ä–∞—Ñ–∏–∫–∞');
        const dynamicContainer = document.getElementById('dynamicGraphContainer');
        if (dynamicContainer) {
            dynamicContainer.innerHTML = '';
            createPlotlyGraph(currentGraph, dynamicContainer);
        }
    }
}

function showDefaultState() {
    console.log('üîÑ –ü–æ–∫–∞–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    
    const defaultState = document.getElementById('defaultState');
    const dynamicContainer = document.getElementById('dynamicGraphContainer');
    const graphArea = document.getElementById('graphArea');
    
    if (!defaultState || !dynamicContainer || !graphArea) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }
    
    // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    defaultState.style.display = 'flex';
    defaultState.style.visibility = 'visible';
    defaultState.style.opacity = '1';
    defaultState.style.position = 'relative';
    defaultState.style.zIndex = '1';
    
    // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    dynamicContainer.style.display = 'none';
    dynamicContainer.style.visibility = 'hidden';
    dynamicContainer.style.opacity = '0';
    dynamicContainer.style.position = 'absolute';
    dynamicContainer.style.zIndex = '-1';
    dynamicContainer.innerHTML = '';
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ graphArea
    graphArea.style.overflow = 'hidden';
    
    // –û—á–∏—â–∞–µ–º Plotly –µ—Å–ª–∏ –µ—Å—Ç—å
    if (typeof Plotly !== 'undefined') {
        const plotlyGraphs = dynamicContainer.querySelectorAll('.js-plotly-plot, .plotly');
        plotlyGraphs.forEach(graph => {
            try {
                Plotly.purge(graph);
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—á–∏—Å—Ç–∫–∏
            }
        });
    }
}

function safeDisplayGraph(graphData, graphType) {
    try {
        console.log('üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞');
        displayGraph(graphData, graphType);
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ safeDisplayGraph:', error);
        showDefaultState();
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞', 'danger');
    }
}

function showEmptyState() {
    const graphContent = document.getElementById('graphContent');
    const emptyState = document.getElementById('emptyState');
    const universalArea = document.getElementById('universalGraphArea');
    
    graphContent.style.display = 'none';
    emptyState.style.display = 'flex';
    universalArea.classList.remove('has-graph');
}


function updateStatistics(stats) {
    const statsContainer = document.getElementById('dataStats');
    
    if (stats && Object.keys(stats).length > 0) {
        let html = `
            <div class="table-responsive h-100 w-100">
                <table class="table table-sm table-hover mb-0">
                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                        <tr>
                            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                            <th>–°—Ä–µ–¥–Ω–µ–µ</th>
                            <th>Std</th>
                            <th>Min</th>
                            <th>Max</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const [param, values] of Object.entries(stats)) {
            html += `
                <tr>
                    <td><small class="fw-bold text-dark">${param}</small></td>
                    <td><small>${values.mean !== null ? values.mean.toFixed(2) : 'N/A'}</small></td>
                    <td><small>${values.std !== null ? values.std.toFixed(2) : 'N/A'}</small></td>
                    <td><small>${values.min !== null ? values.min.toFixed(2) : 'N/A'}</small></td>
                    <td><small>${values.max !== null ? values.max.toFixed(2) : 'N/A'}</small></td>
                    <td><small class="badge bg-primary">${values.count}</small></td>
                </tr>
            `;
        }
        
        html += '</tbody></table></div>';
        statsContainer.innerHTML = html;
    }
}

function resetForm() {
    console.log('üîÑ –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã');
    
    document.getElementById('graph-form').reset();
    initializeForm();
    updateFormOptions();
    clearMessages();
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const graphControls = document.getElementById('graphControls');
    if (graphControls) {
        graphControls.style.display = 'none';
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    showDefaultState();
    
    showMessage('–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'info');
}

function downloadGraph() {
    if (!currentGraph) {
        showMessage('–ù–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
        return;
    }
    
    try {
        if (currentGraphType === 'plotly') {
            // –î–ª—è Plotly –≥—Ä–∞—Ñ–∏–∫–æ–≤
            const plotlyContainer = document.getElementById('plotlyContainer');
            const plotlyGraph = plotlyContainer.querySelector('.js-plotly-plot');
            
            if (plotlyGraph) {
                Plotly.downloadImage(plotlyGraph, {
                    format: 'png',
                    filename: 'plotly_graph',
                    width: 800,
                    height: 600
                });
                showMessage('–ì—Ä–∞—Ñ–∏–∫ Plotly —Å–∫–∞—á–∞–Ω', 'success');
            }
        } else {
            // –î–ª—è matplotlib/seaborn –≥—Ä–∞—Ñ–∏–∫–æ–≤
            const link = document.createElement('a');
            link.download = `graph_${new Date().getTime()}.png`;
            link.href = `data:image/png;base64,${currentGraph}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('–ì—Ä–∞—Ñ–∏–∫ —Å–∫–∞—á–∞–Ω', 'success');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞', 'danger');
    }
}

function toggleFullscreen() {
    console.log('üñ•Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞');
    
    const dynamicContainer = document.getElementById('dynamicGraphContainer');
    if (!dynamicContainer) {
        showMessage('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
        return;
    }
    
    // –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π Plotly –≥—Ä–∞—Ñ–∏–∫
    const plotlyGraph = dynamicContainer.querySelector('.js-plotly-plot, .plotly');
    const matplotlibImage = dynamicContainer.querySelector('img');
    
    if (plotlyGraph && typeof Plotly !== 'undefined') {
        // –î–ª—è Plotly –≥—Ä–∞—Ñ–∏–∫–æ–≤
        handlePlotlyFullscreen(plotlyGraph);
    } else if (matplotlibImage) {
        // –î–ª—è matplotlib –≥—Ä–∞—Ñ–∏–∫–æ–≤
        handleImageFullscreen(matplotlibImage);
    } else {
        // –î–ª—è –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        handleContainerFullscreen(dynamicContainer);
    }
}

function handlePlotlyFullscreen(plotlyGraph) {
    if (!document.fullscreenElement) {
        // –í—Ö–æ–¥ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        if (plotlyGraph.requestFullscreen) {
            plotlyGraph.requestFullscreen();
        } else if (plotlyGraph.webkitRequestFullscreen) {
            plotlyGraph.webkitRequestFullscreen();
        } else if (plotlyGraph.msRequestFullscreen) {
            plotlyGraph.msRequestFullscreen();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä Plotly –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        setTimeout(() => {
            Plotly.Plots.resize(plotlyGraph);
            showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞.', 'info');
        }, 300);
        
    } else {
        // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
    }
}

function handleImageFullscreen(image) {
    if (!document.fullscreenElement) {
        // –í—Ö–æ–¥ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        if (image.requestFullscreen) {
            image.requestFullscreen();
        } else if (image.webkitRequestFullscreen) {
            image.webkitRequestFullscreen();
        } else if (image.msRequestFullscreen) {
            image.msRequestFullscreen();
        }
        showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞.', 'info');
    } else {
        // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
    }
}

function handleContainerFullscreen(container) {
    if (!document.fullscreenElement) {
        // –í—Ö–æ–¥ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        }
        showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞.', 'info');
        
        // –î–ª—è Plotly –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
        setTimeout(() => {
            const plotlyGraph = container.querySelector('.js-plotly-plot');
            if (plotlyGraph && typeof Plotly !== 'undefined') {
                Plotly.Plots.resize(plotlyGraph);
            }
        }, 300);
        
    } else {
        // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        showMessage('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
    }
}

function handleKeyboardShortcuts(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
    }
    
    switch(e.key) {
        case 'Enter':
            e.preventDefault();
            document.getElementById('graph-form').dispatchEvent(new Event('submit'));
            break;
        case 'r':
        case 'R':
            e.preventDefault();
            resetForm();
            break;
        case 'f':
        case 'F':
            e.preventDefault();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            const dynamicContainer = document.getElementById('dynamicGraphContainer');
            if (dynamicContainer && dynamicContainer.style.display !== 'none') {
                toggleFullscreen();
            }
            break;
        case 'Escape':
            // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ ESC
            if (document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.msFullscreenElement) {
                toggleFullscreen();
            }
            break;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
function showMessage(message, type = 'info', duration = 3000) {
    const messagesContainer = document.getElementById('graphMessages');
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    messagesContainer.appendChild(alert);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (type === 'info' && duration > 0) {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, duration);
    }
}

function clearMessages() {
    document.getElementById('graphMessages').innerHTML = '';
}
</script>
{% endblock %}